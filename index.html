<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ARTIFEX AQI - YOUR AIR, YOUR ACTION</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
:root{
  --bg:#050505; --card:rgba(255,255,255,0.04);
  --neon:#00eaff; --accent:#00ff88; --muted:#9aa3b2;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
header{padding:28px 16px;text-align:center;color:var(--neon);font-weight:800;font-size:clamp(18px,4vw,34px);text-shadow:0 0 20px rgba(0,234,255,0.12)}
.container{width:94%;max-width:1200px;margin:0 auto}
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-bottom:18px}
.card{background:var(--card);padding:16px;border-radius:14px;backdrop-filter:blur(6px);box-shadow:0 6px 20px rgba(0,0,0,0.6);transition:transform .26s}
.card .title{color:var(--muted);font-size:0.85rem}
.card .value{margin-top:8px;font-size:clamp(18px,4vw,28px);font-weight:800}
.row{display:flex;gap:16px;align-items:flex-start}
.left{flex:2}
.right{flex:1}
.section{background:var(--card);padding:14px;border-radius:12px;margin-bottom:14px}
.canvas-wrap{height:320px;position:relative;border-radius:10px;overflow:hidden}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn.primary{background:var(--neon);color:#001;box-shadow:0 6px 18px rgba(0,234,255,0.06)}
#liveIndicator{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:10px;font-size:0.9rem;color:var(--neon);pointer-events:none;z-index:30}
.range-panel{position:absolute;top:48px;left:0;background:#080808;border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:10px;box-shadow:0 12px 40px rgba(0,0,0,0.6);width:220px;z-index:40}
.dropdown-item{padding:8px;border-radius:8px;margin-bottom:6px;cursor:pointer}
.dropdown-item:hover{background:rgba(255,255,255,0.02)}
.footer{padding:18px;text-align:center;color:var(--muted);font-size:0.85rem}
.alert{position:fixed;right:14px;top:14px;padding:12px 14px;border-radius:10px;background:#111;box-shadow:0 8px 30px rgba(0,0,0,0.6);z-index:9999;display:none}
.small-muted{color:var(--muted);font-size:0.9rem}

/* Responsive mobile-first rules */
@media (max-width: 900px){
  .cards{grid-template-columns:repeat(2,1fr)}
  .row{flex-direction:column}
  .left,.right{width:100%}
  .canvas-wrap{height:260px}
}
@media (max-width:600px){
  .cards{grid-template-columns:repeat(1,1fr)}
  .container{width:96%}
  .canvas-wrap{height:220px}
  .btn{padding:8px 9px;font-size:14px}
  header{padding:20px}
}

/* low-power and reduced motion */
@media (prefers-reduced-motion: reduce){
  *{transition:none!important}
}
</style>
</head>
<body>
<header>ARTIFEX AQI - YOUR AIR, YOUR ACTION</header>
<div id="particles-js"></div>
<div class="container">

  <div class="cards">
    <div class="card"><div class="title">Device</div><div class="value"><span id="deviceId">AIR-SENSE-PRO</span> · <small id="connStatusText">Connecting...</small></div><div style="margin-top:8px" class="small-muted"><span id="connDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ffd166;margin-right:8px"></span><span id="lastSeen">Last update: --</span></div></div>
    <div class="card"><div class="title">AQI Status</div><div id="statusCard" class="value">--</div></div>
    <div class="card"><div class="title">Temperature</div><div id="tempCard" class="value">-- °C</div></div>
    <div class="card"><div class="title">Humidity</div><div id="humCard" class="value">-- %</div></div>
  </div>

  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap">
      <h3 style="margin:0">Live Trends</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="btnPPM">PPM</button>
        <button class="btn" id="btnTemp">Temp</button>
        <button class="btn" id="btnHum">Hum</button>
        <button class="btn" id="btnAll">Show All</button>
        <button class="btn primary" id="downloadCsv">Download CSV</button>
      </div>
    </div>
    <div class="canvas-wrap">
      <div id="liveIndicator">Live: PPM</div>
      <canvas id="liveChart"></canvas>
    </div>
  </div>

  <div class="section">
    <h3 style="margin-top:0">Historical Data</h3>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px">
      <div style="position:relative">
        <button id="rangeDropdownBtn" class="btn primary">▼ Select Range</button>
        <div id="rangeDropdown" class="range-panel" style="display:none">
          <div class="dropdown-item" data-range="today">Today</div>
          <div class="dropdown-item" data-range="yesterday">Yesterday</div>
          <div class="dropdown-item" data-range="3days">Last 3 days</div>
          <div class="dropdown-item" data-range="7days">Last 7 days</div>
          <div class="dropdown-item" data-range="24h">Last 24 hours</div>
          <div class="dropdown-item" id="customRangeToggle">Custom Range...</div>
          <div class="custom-range" id="customRangePanel" style="display:none">
            <input id="customStart" placeholder="Start (YYYY-MM-DD HH:MM)" />
            <input id="customEnd" placeholder="End (YYYY-MM-DD HH:MM)" />
            <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="applyCustomRange">Apply</button><button class="btn" id="cancelCustomRange">Cancel</button></div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="zoomInBtn">Zoom In</button>
        <button class="btn" id="zoomOutBtn">Zoom Out</button>
        <button class="btn" id="resetZoomBtn">Reset Zoom</button>
      </div>
    </div>

    <div style="margin-bottom:10px" id="histMetricControls"></div>
    <div class="canvas-wrap"><canvas id="histChart"></canvas></div>
  </div>

  <div class="row">
    <div class="left">
      <div id="predictionBox" class="section">
        <h3 style="margin:0 0 10px 0">Prediction & Advice</h3>
        <div id="predictionText">Waiting for data…</div>
        <div style="margin-top:10px;color:var(--muted);font-size:0.9rem">Health advice will appear here based on forecasted AQI.</div>
      </div>
    </div>
    <div class="right">
      <div class="section">
        <h3 style="margin:0 0 10px 0">Alerts</h3>
        <div><label><input type="checkbox" id="enableVoice" checked/> Enable voice alerts</label></div>
        <div style="margin-top:8px"><label><input type="checkbox" id="enableOnScreen" checked/> On-screen popups</label></div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 10px 0">Quick Health Recommendations</h3>
        <ul id="healthList" style="margin:0;padding-left:18px;color:var(--muted)"></ul>
      </div>
    </div>
  </div>

</div>

<div class="alert" id="alertBox"></div>
<div class="footer">© 2025 — Premium AQI Dashboard</div>

<script>
/* ---------------- FIREBASE CONFIG ----------------
   Replace placeholders with your project's web config. Keep this file using compat SDK. */
const firebaseConfig = {
  apiKey: "AIzaSyDExWY6TkAItsbj7bG5KlGy4Ehvn21Qojw",
  authDomain: "esp32-airquality-monitor.firebaseapp.com",
  databaseURL: "https://esp32-airquality-monitor-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esp32-airquality-monitor",
  storageBucket: "esp32-airquality-monitor.appspot.com",
  messagingSenderId: "793658380467",
  appId: "1:793658380467:web:5c84e543afa345c13520c6"

};

firebase.initializeApp(firebaseConfig);
const DEVICE_ID = 'AIR-SENSE-PRO';
const REF = `devices/${DEVICE_ID.toLowerCase()}/readings`;

/* ---------------- Utilities ---------------- */
function showAlert(msg, color){ const el = document.getElementById('alertBox'); el.innerText = msg; el.style.display='block'; el.style.borderLeft = color?`6px solid ${color}`:''; setTimeout(()=>el.style.display='none',6000); }
function speak(text){ if(!document.getElementById('enableVoice').checked) return; try{ speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }catch(e){} }

/* ---------------- State ---------------- */
let liveHistory = []; let lastTimestamp = null; let connected = false; let currentHistMetric = 'ppm';

/* ---------------- Charts setup ---------------- */
const liveCtx = document.getElementById('liveChart').getContext('2d');
const liveChart = new Chart(liveCtx, {
  type:'line', data:{ labels:[], datasets:[
    {label:'Gas PPM', data:[], borderColor:'#00eaff', tension:0.3, pointRadius:2, borderWidth:3},
    {label:'Temperature °C', data:[], borderColor:'#ff9800', tension:0.3, pointRadius:2, borderWidth:3, hidden:true},
    {label:'Humidity %', data:[], borderColor:'#00ff88', tension:0.3, pointRadius:2, borderWidth:3, hidden:true}
  ]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}} } }
});

const histCtx = document.getElementById('histChart').getContext('2d');
const histChart = new Chart(histCtx, {
  type:'line', data:{ labels:[], datasets:[{label:'AQI (PPM)', data:[], borderColor:'#b84cff', tension:0.25, pointRadius:2, borderWidth:2}] },
  options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, zoom:{ pan:{enabled:true, mode:'x'}, zoom:{wheel:{enabled:true}, pinch:{enabled:true}, mode:'x'} } }, scales:{ x:{ticks:{color:'#fff', autoSkip:true, maxTicksLimit:8}}, y:{ticks:{color:'#fff'}} }
});

/* ---------------- AQI color + health ---------------- */
function aqiMeta(ppm){ ppm = Number(ppm)||0; if(ppm<80) return {label:'Good', color:'#19d37c', health:'Low risk. Normal activities.'}; if(ppm<150) return {label:'Moderate', color:'#ffd166', health:'Reduce prolonged outdoor exertion.'}; if(ppm<250) return {label:'Unhealthy', color:'#ff4d6d', health:'Avoid long outdoor activity.'}; return {label:'Hazardous', color:'#b84cff', health:'Stay indoors; use masks/air purifiers.'}; }

function updateCards(obj){ document.getElementById('tempCard').innerText = obj.temperature+' °C'; document.getElementById('humCard').innerText = obj.humidity+' %'; document.getElementById('statusCard').innerText = aqiMeta(obj.gas_ppm).label; document.getElementById('statusCard').style.color = aqiMeta(obj.gas_ppm).color; document.getElementById('ppmCard')?.remove?.(); // keep simple
 document.getElementById('connStatusText').innerText = connected?'Online':'Offline'; document.getElementById('lastSeen').innerText = 'Last update: '+ new Date().toLocaleString(); const list = document.getElementById('healthList'); list.innerHTML=''; const meta = aqiMeta(obj.gas_ppm); [meta.health,'If you have respiratory conditions, keep inhaler/meds handy.','Consider indoor purifier when AQI is high.'].forEach(i=>{ const li=document.createElement('li'); li.innerText=i; list.appendChild(li); }); }

/* ---------------- Firebase realtime ---------------- */
firebase.database().ref(REF).limitToLast(1).on('child_added', snap => {
  const val = snap.val(); if(!val) return; connected=true; lastTimestamp = snap.key || new Date().toISOString(); liveHistory.push({ts:lastTimestamp, ...val}); if(liveHistory.length>2000) liveHistory.shift();
  const tLabel = new Date().toLocaleTimeString(); liveChart.data.labels.push(tLabel); liveChart.data.datasets[0].data.push(val.gas_ppm); liveChart.data.datasets[1].data.push(val.temperature); liveChart.data.datasets[2].data.push(val.humidity);
  if(liveChart.data.labels.length>60){ liveChart.data.labels.shift(); liveChart.data.datasets.forEach(d=>d.data.shift()); }
  liveChart.update(); updateCards(val);
  const ppmArr = liveHistory.slice(-30).map(x=>parseFloat(x.gas_ppm)); runForecast(ppmArr);
  const meta = aqiMeta(val.gas_ppm); if(val.gas_ppm>150){ if(document.getElementById('enableOnScreen').checked) showAlert('High AQI: '+meta.label, meta.color); speak('Warning. Air quality is '+meta.label); }
});

/* ---------------- Live indicator & toggles ---------------- */
const indicator = document.getElementById('liveIndicator');
function setLiveMode(mode){ if(mode==='ppm'){ liveChart.data.datasets[0].hidden=false; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=true; indicator.innerText='Live: PPM'; }
 if(mode==='temp'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=false; liveChart.data.datasets[2].hidden=true; indicator.innerText='Live: Temperature'; }
 if(mode==='hum'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=false; indicator.innerText='Live: Humidity'; }
 if(mode==='all'){ liveChart.data.datasets.forEach(d=>d.hidden=false); indicator.innerText='Live: All Sensors'; }
 liveChart.update(); }

document.getElementById('btnPPM').addEventListener('click',()=>setLiveMode('ppm'));
document.getElementById('btnTemp').addEventListener('click',()=>setLiveMode('temp'));
document.getElementById('btnHum').addEventListener('click',()=>setLiveMode('hum'));
document.getElementById('btnAll').addEventListener('click',()=>setLiveMode('all'));

/* ---------------- CSV download ---------------- */
document.getElementById('downloadCsv').addEventListener('click',()=>{
  if(liveHistory.length===0){ showAlert('No data to download'); return; }
  const headers = ['timestamp','temperature_c','humidity_pct','mq135_ppm','aqi_status']; const rows = liveHistory.map(r=>[r.ts||'', r.temperature, r.humidity, r.gas_ppm, r.status||'']); let csv = headers.join(',') + '\n'; rows.forEach(r=>{ csv += r.map(v=>('"'+String(v).replace(/"/g,'""')+'"')).join(',') + '\n'; }); const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `${DEVICE_ID}_data.csv`; a.click(); URL.revokeObjectURL(url);
});

/* ---------------- Historical loading + animated highlight ---------------- */
async function loadRange(startMs,endMs,metric='ppm'){
  const snap = await firebase.database().ref(REF).once('value'); const data = snap.val(); if(!data){ showAlert('No historical data'); return; }
  const items = Object.keys(data).map(k=>({ts:k,...data[k]})); const filtered = items.filter(it=>{ const ts = Date.parse(it.ts.replace(/_/g,':').replace('T',' ')); return !isNaN(ts) && ts>=startMs && ts<=endMs; }); filtered.sort((a,b)=>Date.parse(a.ts)-Date.parse(b.ts)); histChart.data.labels = filtered.map(x=> (new Date(x.ts.replace(/_/g,':').replace('T',' '))).toLocaleString()); if(metric==='ppm'){ histChart.data.datasets[0].data = filtered.map(x=>parseFloat(x.gas_ppm)); histChart.data.datasets[0].label='AQI (PPM)'; histChart.data.datasets[0].borderColor='#b84cff'; }
  if(metric==='temp'){ histChart.data.datasets[0].data = filtered.map(x=>parseFloat(x.temperature)); histChart.data.datasets[0].label='Temperature (°C)'; histChart.data.datasets[0].borderColor='#ff9800'; }
  if(metric==='hum'){ histChart.data.datasets[0].data = filtered.map(x=>parseFloat(x.humidity)); histChart.data.datasets[0].label='Humidity (%)'; histChart.data.datasets[0].borderColor='#00ff88'; }
  histChart.update(); // animated highlight
  gsap.fromTo('#histChart',{boxShadow:'0 0 0 rgba(0,0,0,0)'},{boxShadow:'0 0 30px rgba(184,76,255,0.12)',duration:0.45,yoyo:true,repeat:1});
  // update health summary (avg ppm)
  const avg = filtered.length? (filtered.reduce((s,x)=>s + (parseFloat(x.gas_ppm)||0),0)/filtered.length):0; const meta = aqiMeta(avg); document.getElementById('predictionText').innerHTML = `<strong>Range forecast (avg):</strong><br>Avg AQI (approx): <span style="color:${meta.color};font-weight:800">${Math.round(avg)}</span><br><em>${meta.health}</em>`;
}

/* ---------------- Range helpers & dropdown wiring ---------------- */
const ddBtn = document.getElementById('rangeDropdownBtn'); const ddMenu = document.getElementById('rangeDropdown'); const ddItems = ddMenu.querySelectorAll('.dropdown-item'); let dropdownOpen=false;

ddBtn.addEventListener('click', ()=>{ dropdownOpen = !dropdownOpen; if(dropdownOpen){ ddBtn.innerText='▲ Select Range'; gsap.to(ddMenu,{height:'auto',duration:0.35,opacity:1,display:'block',ease:'power2.out'}); } else { ddBtn.innerText='▼ Select Range'; gsap.to(ddMenu,{height:0,duration:0.25,opacity:0,display:'none',ease:'power2.in'}); } });

ddItems.forEach(it=>{ it.addEventListener('click', e=>{ const r = e.currentTarget.getAttribute('data-range'); if(r) { handleRangeSelection(r); } if(e.currentTarget.id==='customRangeToggle'){ document.getElementById('customRangePanel').style.display='block'; } }); });

document.getElementById('cancelCustomRange').addEventListener('click', ()=>{ document.getElementById('customRangePanel').style.display='none'; });

function handleRangeSelection(r){ ddBtn.innerText='▼ Select Range'; gsap.to(ddMenu,{height:0,opacity:0,display:'none',duration:0.2}); dropdownOpen=false; if(r==='today') loadToday(currentHistMetric); if(r==='yesterday') loadYesterday(currentHistMetric); if(r==='3days') loadDays(3,currentHistMetric); if(r==='7days') loadDays(7,currentHistMetric); if(r==='24h') loadLastHours(24,currentHistMetric); }

flatpickr('#customStart',{enableTime:true,dateFormat:'Y-m-d H:i'}); flatpickr('#customEnd',{enableTime:true,dateFormat:'Y-m-d H:i'});
document.getElementById('applyCustomRange').addEventListener('click', ()=>{ const s=document.getElementById('customStart').value; const e=document.getElementById('customEnd').value; if(!s||!e){ showAlert('Please set start and end'); return; } const startMs = Date.parse(s.replace(' ','T')); const endMs = Date.parse(e.replace(' ','T')); if(isNaN(startMs)||isNaN(endMs)){ showAlert('Invalid dates'); return; } loadRange(startMs,endMs,currentHistMetric); document.getElementById('customRangePanel').style.display='none'; ddBtn.innerText='▼ Select Range'; dropdownOpen=false; gsap.to(ddMenu,{height:0,opacity:0,display:'none',duration:0.2}); });

/* ---------------- Historical metric controls (AQI/temp/hum) ---------------- */
const histControlsContainer = document.getElementById('histMetricControls'); const btnAQI=document.createElement('button'); btnAQI.className='btn'; btnAQI.innerText='AQI'; btnAQI.onclick=()=>{ currentHistMetric='ppm'; loadLastHours(24,'ppm'); }; const btnT=document.createElement('button'); btnT.className='btn'; btnT.innerText='Temperature'; btnT.onclick=()=>{ currentHistMetric='temp'; loadLastHours(24,'temp'); }; const btnH=document.createElement('button'); btnH.className='btn'; btnH.innerText='Humidity'; btnH.onclick=()=>{ currentHistMetric='hum'; loadLastHours(24,'hum'); }; histControlsContainer.appendChild(btnAQI); histControlsContainer.appendChild(btnT); histControlsContainer.appendChild(btnH);

/* ---------------- Historical load helpers ---------------- */
async function loadToday(metric){ const now=new Date(); const start=new Date(now.getFullYear(),now.getMonth(),now.getDate()); await loadRange(start.getTime(), Date.now(), metric); }
async function loadYesterday(metric){ const now=new Date(); const start=new Date(now.getFullYear(),now.getMonth(),now.getDate()-1); const end=new Date(now.getFullYear(),now.getMonth(),now.getDate()); await loadRange(start.getTime(), end.getTime(), metric); }
async function loadDays(n,metric){ const end=Date.now(); const start=end - n*24*60*60*1000; await loadRange(start,end,metric); }
async function loadLastHours(h,metric){ const cutoff = Date.now() - h*60*60*1000; await loadRange(cutoff, Date.now(), metric); }

/* ---------------- Zoom controls ---------------- */
function zoomInHist(){ try{ histChart.zoom(1.2); }catch(e){ showAlert('Zoom not available'); } }
function zoomOutHist(){ try{ histChart.zoom(0.8); }catch(e){ showAlert('Zoom not available'); } }
function resetZoomHist(){ try{ histChart.resetZoom(); }catch(e){ showAlert('Reset zoom not available'); } }

document.getElementById('zoomInBtn').addEventListener('click', zoomInHist);
document.getElementById('zoomOutBtn').addEventListener('click', zoomOutHist);
document.getElementById('resetZoomBtn').addEventListener('click', resetZoomHist);

/* ---------------- Simple ML forecast (linear regression) ---------------- */
function linearRegressionPredict(arr,forwardSteps=6){ const N=Math.min(20,arr.length); if(N<3) return null; const xs=[], ys=[]; for(let i=0;i<N;i++){ xs.push(i); ys.push(arr[arr.length-N+i]); } const xMean=xs.reduce((a,b)=>a+b,0)/N, yMean=ys.reduce((a,b)=>a+b,0)/N; let num=0, den=0; for(let i=0;i<N;i++){ num+=(xs[i]-xMean)*(ys[i]-yMean); den+=(xs[i]-xMean)*(xs[i]-xMean); } const m=den===0?0:num/den; const c=yMean-m*xMean; const pred=m*(N+forwardSteps)+c; return Math.max(0, Math.round(pred)); }
function runForecast(ppmArr){ const pred = linearRegressionPredict(ppmArr,6); if(pred===null) return; const meta=aqiMeta(pred); document.getElementById('predictionText').innerHTML = `<strong>Next ~30-60 min forecast:</strong><br>Predicted AQI (approx): <span style="color:${meta.color};font-weight:800">${pred}</span><br><em>${meta.health}</em>`; }

/* ---------------- Init UI animation & load defaults ---------------- */
particlesJS('particles-js',{particles:{number:{value:48},color:{value:'#00eaff'},opacity:{value:0.6},size:{value:2}},interactivity:{detect_on:'canvas'}});
gsap.from('.card',{y:12,opacity:0,duration:0.7,stagger:0.05});
// default load last 24h AQI
loadLastHours(24,'ppm');

/* ---------------- connection indicator ---------------- */
setInterval(()=>{ if(!lastTimestamp){ connected=false; setConnection(false); return; } const last = Date.parse(lastTimestamp.replace(/_/g,':').replace('T',' ')); if(isNaN(last)){ setConnection(false); return; } const diff = Date.now()-last; setConnection(diff<120000); },3000);
function setConnection(online){ connected=online; document.getElementById('connStatusText').innerText = online?'Online':'Offline'; document.getElementById('connDot').style.background = online? '#19d37c' : '#ffd166'; }

</script>
</body>
</html>
