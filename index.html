<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARTIFEX AQI - YOUR AIR, YOUR ACTION</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#000000" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Chart.js + zoom plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umm.min.js"></script>
  <script src="https://unpkg.com/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

  <!-- small helpers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root{
      --bg:#050505; --card:rgba(255,255,255,0.03);
      --neon:#00eaff; --accent:#00ff88; --muted:#9aa3b2;
      --glass: rgba(255,255,255,0.02);
      --radius: 12px;
      --glow: 0 8px 30px rgba(0,234,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased;line-height:1.3}
    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.08));border-bottom:1px solid rgba(255,255,255,0.02);backdrop-filter: blur(6px)}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#00eaff,#00ff88);display:flex;align-items:center;justify-content:center;font-weight:900;color:#002;font-size:18px;box-shadow:var(--glow)}
    .brand h1{margin:0;font-size:clamp(18px,2.6vw,28px);letter-spacing:1px;color:var(--neon)}
    .nav{display:flex;gap:12px;align-items:center}
    .nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:8px}
    .nav a.active{color:#001;background:var(--neon);box-shadow:0 6px 20px rgba(0,234,255,0.06)}
    .container{width:94%;max-width:1300px;margin:18px auto}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 3;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.6);}
    .card .title{color:var(--muted);font-size:0.85rem}
    .card .value{font-weight:800;font-size:clamp(18px,2.8vw,28px);margin-top:8px}
    .section{grid-column:span 8;background:var(--card);padding:16px;border-radius:12px}
    .side{grid-column:span 4;background:var(--card);padding:16px;border-radius:12px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--neon);color:#001;box-shadow:var(--glow)}
    .canvas-wrap{height:360px;border-radius:10px;overflow:hidden;position:relative;background:linear-gradient(180deg, rgba(255,255,255,0.006), transparent)}
    #liveIndicator{position:absolute;left:12px;top:12px;z-index:12;background:rgba(0,0,0,0.6);color:var(--neon);padding:6px 10px;border-radius:10px;font-weight:700}
    .footer{padding:22px;text-align:center;color:var(--muted);font-size:0.85rem;margin-top:18px}

    /* right cards with neon heading + glow border */
    .neon-card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:14px;position:relative;box-shadow:0 8px 40px rgba(0,0,0,0.6)}
    .neon-card .card-head{font-weight:800;margin:0 0 8px 0;padding:6px 8px;border-radius:8px;display:inline-block}
    .neon-border{box-shadow:0 0 0 rgba(0,0,0,0);border-left:4px solid rgba(255,255,255,0.02);transition:box-shadow .25s, border-color .25s}
    .neon-border.good{border-color: #19d37c; box-shadow:0 8px 30px rgba(25,211,124,0.06)}
    .neon-border.moderate{border-color: #ffd166; box-shadow:0 8px 30px rgba(255,209,102,0.06)}
    .neon-border.unhealthy{border-color: #ff4d6d; box-shadow:0 8px 30px rgba(255,77,109,0.06)}
    .neon-border.hazard{border-color: #b84cff; box-shadow:0 8px 30px rgba(184,76,255,0.06)}

    /* styled inputs (no harsh white) */
    .threshold { background:#0b0b0b;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px 8px;border-radius:6px;width:100px }
    .threshold:focus{outline:none;border-color:var(--neon);box-shadow:0 6px 18px rgba(0,234,255,0.06);color:#fff}

    /* dropdowns / selects themed */
    .select-themed { background:#0b0b0b; color:#fff; border-radius:8px; padding:8px 12px; border:1px solid rgba(255,255,255,0.04); appearance:none; -webkit-appearance:none; min-width:150px }
    .select-wrap { position:relative; display:inline-block; }
    .select-wrap::after{ content:'▾'; position:absolute; right:10px; top:8px; color:var(--muted); pointer-events:none; }

    .legend { display:flex; gap:10px; align-items:center; color:var(--muted); font-size:0.9rem; margin-top:6px }

    /* responsive */
    @media (max-width:1100px){
      .card{grid-column:span 6}
      .section{grid-column:span 12}
      .side{grid-column:span 12}
      .canvas-wrap{height:320px}
    }
    @media (max-width:700px){
      .brand h1{font-size:18px}
      .grid{gap:12px}
      .card{grid-column:span 12}
      .canvas-wrap{height:220px}
    }
    @media (prefers-reduced-motion: reduce){*{transition:none!important}}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo">ART</div>
      <div>
        <h1>ARTIFEX AQI — YOUR AIR, YOUR ACTION</h1>
        <div style="color:var(--muted);font-size:0.85rem;margin-top:4px">Real-time Air Quality Intelligence</div>
      </div>
    </div>
    <div class="nav">
      <a class="active" href="#">Dashboard</a>
      <a href="#">History</a>
      <a href="#" id="shareBtn">Share</a>
    </div>
  </div>

  <div class="container">
    <div class="grid" style="margin-bottom:16px">
      <div class="card">
        <div class="title">Device</div>
        <div class="value"><span id="deviceId">AIR-SENSE-PRO</span> · <small id="connStatusText">Connecting...</small></div>
        <div style="margin-top:8px;color:var(--muted)"><span id="connDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ffd166;margin-right:8px"></span><span id="lastSeen">Last update: --</span></div>
      </div>
      <div class="card">
        <div class="title">AQI Status</div>
        <div id="statusCard" class="value">--</div>
      </div>
      <div class="card">
        <div class="title">Temperature</div>
        <div id="tempCard" class="value">-- °C</div>
      </div>
      <div class="card">
        <div class="title">Humidity</div>
        <div id="humCard" class="value">-- %</div>
      </div>
    </div>

    <div class="grid" style="align-items:start">
      <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap">
          <h3 style="margin:0">Live Trends</h3>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btn" id="btnPPM">PPM</button>
            <button class="btn" id="btnTemp">Temp</button>
            <button class="btn" id="btnHum">Hum</button>
            <button class="btn" id="btnAll">Show All</button>
            <button class="btn primary" id="downloadCsv">Download CSV</button>
          </div>
        </div>

        <div class="canvas-wrap">
          <div id="liveIndicator">Live: PPM</div>
          <canvas id="liveChart"></canvas>
        </div>

        <!-- Historical & Comparison -->
        <div style="margin-top:12px;padding-top:12px">
          <h3 style="margin:0 0 8px 0;color:var(--neon)">Historical Data & Comparison</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
            <div class="select-wrap">
              <select id="rangeSelect" class="select-themed">
                <option value="today">Today (midnight → now)</option>
                <option value="yesterday">Yesterday</option>
                <option value="3days">Last 3 days</option>
                <option value="24h">Last 24 hours</option>
                <option value="7days">Last 7 days</option>
              </select>
            </div>

            <div class="select-wrap">
              <select id="compareMetric" class="select-themed">
                <option value="aqi">AQI</option>
                <option value="temp">Temperature</option>
                <option value="hum">Humidity</option>
              </select>
            </div>

            <button class="btn" id="compareBtn">Compare (Today vs Yesterday)</button>

            <div class="legend" style="margin-left:auto">
              <span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:6px;background:#00eaff;display:inline-block;border-radius:3px"></span> PPM</span>
              <span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:6px;background:#ff9800;display:inline-block;border-radius:3px"></span> Temp</span>
              <span style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:6px;background:#00ff88;display:inline-block;border-radius:3px"></span> Humidity</span>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="canvas-wrap"><canvas id="histChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="side">
        <!-- Prediction -->
        <div id="predictionCard" class="neon-card neon-border" role="region" aria-label="Prediction">
          <div class="card-head" id="predictionHead" style="background:transparent;color:var(--neon)">Prediction — Next 1 hour</div>
          <div style="font-size:26px;font-weight:800;margin-top:8px" id="predScore">--</div>
          <div id="predLabel" style="color:var(--muted);margin-top:6px">Waiting for data</div>
          <div style="margin-top:10px;color:var(--muted);font-size:0.9rem" id="predNote">Based on linear regression</div>
        </div>

        <!-- Alerts & customization -->
        <div id="alertsCard" class="neon-card neon-border" role="region" aria-label="Alerts customization">
          <div class="card-head" id="alertsHead" style="background:transparent;color:var(--neon)">Alerts & Customization</div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <label style="display:flex;gap:8px;align-items:center"><span style="width:200px;color:var(--muted)">PPM warning threshold:</span><input id="thPPM" class="threshold" value="150" type="number" /></label>
            <label style="display:flex;gap:8px;align-items:center"><span style="width:200px;color:var(--muted)">Temperature threshold (°C):</span><input id="thTemp" class="threshold" value="40" type="number" /></label>
            <label style="display:flex;gap:8px;align-items:center"><span style="width:200px;color:var(--muted)">Humidity threshold (%):</span><input id="thHum" class="threshold" value="75" type="number" /></label>

            <div style="display:flex;gap:8px;align-items:center">
              <label style="color:var(--muted)"><input id="enableVoice" type="checkbox" checked /> Enable voice</label>
              <label style="color:var(--muted)"><input id="enableOnScreen" type="checkbox" checked /> On-screen</label>
            </div>
          </div>
        </div>

        <!-- Health recommendation -->
        <div id="healthCard" class="neon-card neon-border" role="region" aria-label="Health recommendations">
          <div class="card-head" id="healthHead" style="background:transparent;color:var(--neon)">Health Recommendation</div>
          <div id="healthText" style="margin-top:10px;color:var(--muted)">
            Waiting for AQI...
          </div>
        </div>
      </div>
    </div>

    <div class="footer">© 2025 — ARTIFEX — Built by Rishi</div>
  </div>

  <div class="alert" id="alertBox" style="display:none"></div>

  <script>
  /*************** FIREBASE CONFIG - replace with your config ***************/
  const firebaseConfig = {
    apiKey: "AIzaSyDExWY6TkAItsbj7bG5KlGy4Ehvn21Qojw",
    authDomain: "esp32-airquality-monitor.firebaseapp.com",
    databaseURL: "https://esp32-airquality-monitor-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "esp32-airquality-monitor",
    storageBucket: "esp32-airquality-monitor.appspot.com",
    messagingSenderId: "793658380467",
    appId: "1:793658380467:web:5c84e543afa345c13520c6"
  };
  firebase.initializeApp(firebaseConfig);

  /*************** SETTINGS ***************/
  const DEVICE_ID = 'AIR-SENSE-PRO';                 // change this to rename device path
  const REF = 'devices/' + DEVICE_ID + '/readings';

  /*************** UTILITIES ***************/
  function showAlert(msg, color){
    const el = document.getElementById('alertBox'); el.innerText = msg; el.style.display = 'block'; el.style.borderLeft = color?('6px solid '+color):''; setTimeout(()=>el.style.display='none',6000);
  }
  function speak(t){ if(!document.getElementById('enableVoice').checked) return; try{ speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance(t)); }catch(e){} }
  function parseTimestampKey(key){
    if(!key) return NaN;
    let s = String(key).trim();
    s = s.replace(/_/g,':');
    s = s.replace(/\s+T\s+/,'T'); s = s.replace(/\s+/,'T');
    const parts = s.split(':');
    if(parts.length > 2 && parts[0].indexOf('-')!==-1 && parts[0].indexOf('T')===-1){
      s = s.replace(/:/, 'T');
    }
    const t = Date.parse(s);
    return isNaN(t) ? NaN : t;
  }

  /*************** STATE & CHARTS ***************/
  let liveHistory = [], lastTimestamp = null, connected = false;
  const liveCtx = document.getElementById('liveChart').getContext('2d');
  const liveChart = new Chart(liveCtx, {
    type:'line',
    data:{ labels:[], datasets:[
      {label:'Gas PPM', data:[], borderColor:'#00eaff', tension:0.3, pointRadius:2, borderWidth:2},
      {label:'Temperature °C', data:[], borderColor:'#ff9800', tension:0.3, pointRadius:2, borderWidth:2, hidden:true},
      {label:'Humidity %', data:[], borderColor:'#00ff88', tension:0.3, pointRadius:2, borderWidth:2, hidden:true}
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}} } }
  });

  const histCtx = document.getElementById('histChart').getContext('2d');
  const histChart = new Chart(histCtx, {
    type:'line',
    data:{ labels:[], datasets:[
      {label:'Metric', data:[], borderColor:'#b84cff', tension:0.25, pointRadius:2, borderWidth:2}
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        zoom:{ pan:{enabled:true, mode:'x'}, zoom:{wheel:{enabled:true}, pinch:{enabled:true}, mode:'x'} }
      },
      scales:{ x:{ticks:{color:'#fff',autoSkip:true,maxTicksLimit:8}}, y:{ticks:{color:'#fff'}} }
    }
  });

  /*************** AQI meta & UI update ***************/
  function aqiMeta(ppm){
    ppm = Number(ppm)||0;
    if(ppm<80) return {label:'Good', color:'#19d37c', health:'Low risk. Normal activities.'};
    if(ppm<150) return {label:'Moderate', color:'#ffd166', health:'Reduce prolonged outdoor exertion.'};
    if(ppm<250) return {label:'Unhealthy', color:'#ff4d6d', health:'Avoid long outdoor activity.'};
    return {label:'Hazardous', color:'#b84cff', health:'Stay indoors; use masks/air purifiers.'};
  }

  function updateCards(obj){
    document.getElementById('tempCard').innerText = (obj.temperature===undefined? '--' : obj.temperature) + ' °C';
    document.getElementById('humCard').innerText = (obj.humidity===undefined? '--' : obj.humidity) + ' %';
    const ppmVal = (obj.gas_ppm===undefined? '--' : obj.gas_ppm);
    // status
    const meta = aqiMeta(ppmVal);
    const statusEl = document.getElementById('statusCard');
    statusEl.innerText = meta.label;
    statusEl.style.color = meta.color;
    document.getElementById('connStatusText').innerText = connected ? 'Online' : 'Offline';
    document.getElementById('lastSeen').innerText = lastTimestamp ? new Date(parseTimestampKey(lastTimestamp)).toLocaleString() : '--';

    // set neon border classes
    const classes = (meta.label==='Good'?'good': meta.label==='Moderate'?'moderate': meta.label==='Unhealthy'?'unhealthy':'hazard');
    document.getElementById('predictionCard').className = 'neon-card neon-border ' + classes;
    document.getElementById('alertsCard').className = 'neon-card neon-border ' + classes;
    document.getElementById('healthCard').className = 'neon-card neon-border ' + classes;

    // prediction card
    const predScore = document.getElementById('predScore');
    predScore.innerText = ppmVal === '--' ? '--' : Math.round(ppmVal);
    document.getElementById('predLabel').innerText = meta.label;
    document.getElementById('predNote').innerText = 'Based on linear regression';

    // health card dynamic advice
    const h = document.getElementById('healthText');
    h.innerHTML = `<strong>${meta.label}</strong><br>${meta.health}<br><br>Recommendations:<br>`;
    if(meta.label === 'Good'){
      h.innerHTML += 'Normal activities. Open windows if comfortable.';
    } else if(meta.label === 'Moderate'){
      h.innerHTML += 'Limit prolonged outdoor activity; sensitive people should reduce exertion.';
    } else if(meta.label === 'Unhealthy'){
      h.innerHTML += 'Avoid long outdoor activity; consider masks & purifier.';
    } else {
      h.innerHTML += 'Stay indoors; use high-efficiency air purifier; keep windows closed.';
    }
  }

  /*************** Linear regression forecast (simple) ***************/
  function linearRegressionPredict(arr, forwardSteps=6){
    const N = Math.min(20, arr.length); if(N<3) return null;
    const xs = [], ys = [];
    for(let i=0;i<N;i++){ xs.push(i); ys.push(Number(arr[arr.length-N+i]||0)); }
    const xMean = xs.reduce((a,b)=>a+b,0)/N, yMean = ys.reduce((a,b)=>a+b,0)/N;
    let num=0, den=0; for(let i=0;i<N;i++){ num += (xs[i]-xMean)*(ys[i]-yMean); den += (xs[i]-xMean)*(xs[i]-xMean); }
    const m = den===0?0:num/den; const c = yMean - m*xMean; const pred = m*(N+forwardSteps)+c; return Math.max(0, Math.round(pred));
  }

  function runForecast(ppmArr){
    const pred = linearRegressionPredict(ppmArr, 6);
    if(pred === null) return;
    const meta = aqiMeta(pred);
    document.getElementById('predScore').innerText = pred;
    document.getElementById('predLabel').innerText = meta.label;
    document.getElementById('predNote').innerText = 'Based on linear regression';
    updateCards({ gas_ppm: ppmArr.length?ppmArr[ppmArr.length-1]:pred, temperature: document.getElementById('tempCard').innerText.replace(' °C',''), humidity: document.getElementById('humCard').innerText.replace(' %','')});
  }

  /*************** Realtime listener (safe) ***************/
  try {
    firebase.database().ref(REF).limitToLast(1).on('child_added', snap => {
      if(!liveChart || !liveChart.data) return;
      const val = snap.val(); if(!val) return;
      connected = true; lastTimestamp = snap.key || new Date().toISOString();

      liveHistory.push({ ts: lastTimestamp, ...val });
      if(liveHistory.length > 2000) liveHistory.shift();

      const tLabel = new Date().toLocaleTimeString();
      // push to live chart safely
      liveChart.data.labels.push(tLabel);
      liveChart.data.datasets[0].data.push(Number(val.gas_ppm||0));
      liveChart.data.datasets[1].data.push(Number(val.temperature||0));
      liveChart.data.datasets[2].data.push(Number(val.humidity||0));
      if(liveChart.data.labels.length > 60){ liveChart.data.labels.shift(); liveChart.data.datasets.forEach(d=>d.data.shift()); }
      liveChart.update();

      updateCards(val);

      // forecast & alerts
      const ppmArr = liveHistory.slice(-30).map(x => Number(x.gas_ppm||0));
      runForecast(ppmArr);

      const meta = aqiMeta(val.gas_ppm);
      const ppmWarn = Number(document.getElementById('thPPM').value || 150);
      if(Number(val.gas_ppm) > ppmWarn){
        if(document.getElementById('enableOnScreen').checked) showAlert('High AQI: ' + meta.label, meta.color);
        speak('Warning. Air quality is ' + meta.label);
      }
    });
  } catch(e){
    console.warn('Realtime listener failed, will attempt polling fallback', e);
    setInterval(async ()=>{
      try{
        const snap = await firebase.database().ref(REF).limitToLast(1).once('value');
        const data = snap.val(); if(!data) return;
        const key = Object.keys(data)[0]; const val = data[key];
        // same handling as above
        connected = true; lastTimestamp = key;
        liveHistory.push({ ts:key, ...val }); if(liveHistory.length>2000) liveHistory.shift();
        const tLabel = new Date().toLocaleTimeString();
        liveChart.data.labels.push(tLabel); liveChart.data.datasets[0].data.push(Number(val.gas_ppm||0));
        if(liveChart.data.labels.length > 60){ liveChart.data.labels.shift(); liveChart.data.datasets.forEach(d=>d.data.shift()); }
        liveChart.update(); updateCards(val);
      }catch(err){ console.warn(err); }
    }, 15000);
  }

  /*************** Buttons and UI wiring ***************/
  document.getElementById('btnPPM').addEventListener('click', ()=> setLiveMode('ppm'));
  document.getElementById('btnTemp').addEventListener('click', ()=> setLiveMode('temp'));
  document.getElementById('btnHum').addEventListener('click', ()=> setLiveMode('hum'));
  document.getElementById('btnAll').addEventListener('click', ()=> setLiveMode('all'));
  function setLiveMode(mode){
    if(!liveChart) return;
    if(mode==='ppm'){ liveChart.data.datasets[0].hidden=false; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=true; document.getElementById('liveIndicator').innerText='Live: PPM'; }
    if(mode==='temp'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=false; liveChart.data.datasets[2].hidden=true; document.getElementById('liveIndicator').innerText='Live: Temperature'; }
    if(mode==='hum'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=false; document.getElementById('liveIndicator').innerText='Live: Humidity'; }
    if(mode==='all'){ liveChart.data.datasets.forEach(d=>d.hidden=false); document.getElementById('liveIndicator').innerText='Live: All Sensors'; }
    liveChart.update();
  }

  document.getElementById('downloadCsv').addEventListener('click', ()=>{
    if(liveHistory.length===0){ showAlert('No data to download'); return; }
    const headers = ['timestamp','temperature_c','humidity_pct','mq135_ppm','aqi_status'];
    const rows = liveHistory.map(r=>[r.ts||'', r.temperature, r.humidity, r.gas_ppm, r.status||'']);
    let csv = headers.join(',') + '\n';
    rows.forEach(r=>{ csv += r.map(v=>('"'+String(v).replace(/"/g,'""')+'"')).join(',') + '\n'; });
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${DEVICE_ID}_data.csv`; a.click(); URL.revokeObjectURL(url);
  });

  /*************** Historical loading & comparison ***************/
  async function loadRange(startMs, endMs, metric='aqi'){
    try{
      const snap = await firebase.database().ref(REF).once('value');
      const data = snap.val();
      if(!data){ showAlert('No historical data'); return; }
      const items = Object.keys(data).map(k => ({ ts:k, ...data[k] }));
      const filtered = items.filter(it => {
        const ts = parseTimestampKey(it.ts);
        return !isNaN(ts) && ts >= startMs && ts <= endMs;
      });
      filtered.sort((a,b)=> parseTimestampKey(a.ts) - parseTimestampKey(b.ts));
      histChart.data.labels = filtered.map(x => (new Date(parseTimestampKey(x.ts))).toLocaleString());
      if(metric==='aqi') histChart.data.datasets[0].data = filtered.map(x=>Number(x.gas_ppm||0)), histChart.data.datasets[0].borderColor='#b84cff';
      else if(metric==='temp') histChart.data.datasets[0].data = filtered.map(x=>Number(x.temperature||0)), histChart.data.datasets[0].borderColor='#ff9800';
      else if(metric==='hum') histChart.data.datasets[0].data = filtered.map(x=>Number(x.humidity||0)), histChart.data.datasets[0].borderColor='#00ff88';
      histChart.update();
      showAlert('Loaded ' + filtered.length + ' points');
    }catch(e){ console.error(e); showAlert('Error: '+e.message); }
  }

  function nowMidnight(){ const n = new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()).getTime(); }

  document.getElementById('rangeSelect').addEventListener('change', async (e)=>{
    const v = e.target.value;
    if(v==='today') await loadRange(nowMidnight(), Date.now(), 'aqi');
    else if(v==='yesterday'){
      const start = nowMidnight() - 24*3600*1000, end = nowMidnight();
      await loadRange(start, end, 'aqi');
    } else if(v==='3days'){
      await loadRange(Date.now() - 3*24*3600*1000, Date.now(), 'aqi');
    } else if(v==='24h'){ await loadRange(Date.now() - 24*3600*1000, Date.now(), 'aqi'); }
    else if(v==='7days'){ await loadRange(Date.now() - 7*24*3600*1000, Date.now(), 'aqi'); }
  });

  document.getElementById('compareBtn').addEventListener('click', async ()=>{
    const metric = document.getElementById('compareMetric').value;
    // Today vs Yesterday overlay
    const todayStart = nowMidnight(), todayEnd = Date.now();
    const yStart = nowMidnight() - 24*3600*1000, yEnd = nowMidnight();
    // load both sets then overlay
    const snap = await firebase.database().ref(REF).once('value'); const data = snap.val(); if(!data){ showAlert('No data'); return; }
    const items = Object.keys(data).map(k=>({ts:k,...data[k]}));
    const today = items.filter(it=> { const t=parseTimestampKey(it.ts); return !isNaN(t) && t>=todayStart && t<=todayEnd; }).sort((a,b)=>parseTimestampKey(a.ts)-parseTimestampKey(b.ts));
    const yesterday = items.filter(it=> { const t=parseTimestampKey(it.ts); return !isNaN(t) && t>=yStart && t<=yEnd; }).sort((a,b)=>parseTimestampKey(a.ts)-parseTimestampKey(b.ts));

    // overlay: create two datasets
    histChart.data.labels = today.map(x=> new Date(parseTimestampKey(x.ts)).toLocaleTimeString());
    const d1 = metric==='aqi' ? today.map(x=>Number(x.gas_ppm||0)) : metric==='temp' ? today.map(x=>Number(x.temperature||0)) : today.map(x=>Number(x.humidity||0));
    const d2 = metric==='aqi' ? yesterday.map(x=>Number(x.gas_ppm||0)) : metric==='temp' ? yesterday.map(x=>Number(x.temperature||0)) : yesterday.map(x=>Number(x.humidity||0));

    // create overlay datasets (today + yesterday)
    histChart.data.datasets = [
      { label: 'Today', data: d1, borderColor: '#b84cff', borderWidth:2, tension:0.2 },
      { label: 'Yesterday', data: d2, borderColor: '#00eaff', borderWidth:2, tension:0.2 }
    ];
    histChart.update();
    showAlert('Comparison loaded');
  });

  /*************** Zoom control helpers ***************/
  function zoomInHist(){ try{ histChart.zoom(1.2); }catch(e){ showAlert('Zoom not available'); } }
  function zoomOutHist(){ try{ histChart.zoom(0.8); }catch(e){ showAlert('Zoom not available'); } }
  function resetZoomHist(){ try{ histChart.resetZoom(); }catch(e){ showAlert('Reset not available'); } }
  document.getElementById('zoomInBtn').addEventListener('click', zoomInHist);
  document.getElementById('zoomOutBtn').addEventListener('click', zoomOutHist);
  document.getElementById('resetZoomBtn').addEventListener('click', resetZoomHist);

  /*************** initial UI + load defaults ***************/
  gsap.from('.card',{y:12,opacity:0,duration:0.7,stagger:0.05});
  // load last 24h by default
  (async ()=>{ await loadRange(Date.now() - 24*3600*1000, Date.now(), 'aqi'); })();

  setInterval(()=> {
    if(!lastTimestamp){ connected=false; setConnection(false); return; }
    const last = parseTimestampKey(lastTimestamp); if(isNaN(last)){ setConnection(false); return; }
    const diff = Date.now() - last; setConnection(diff < 120000);
  },3000);

  function setConnection(online){ connected=online; document.getElementById('connStatusText').innerText = online ? 'Online' : 'Offline'; document.getElementById('connDot').style.background = online? '#19d37c' : '#ffd166'; }

  /*************** PWA: register service worker if available ***************/
  if('serviceWorker' in navigator){
    try{
      navigator.serviceWorker.register('/sw.js').then(()=> console.log('SW registered')).catch(e=> console.warn('SW registration failed', e));
    }catch(err){ console.warn(err); }
  }

  </script>
</body>
</html>
