<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Premium AQI Dashboard — Pro</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js"></script>

<style>
:root{
  --bg:#050505; --card:rgba(255,255,255,0.04);
  --neon:#00eaff; --accent:#00ff88; --muted:#9aa3b2;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto, "Helvetica Neue", Arial;background:var(--bg);color:#fff}
header{padding:36px 20px;text-align:center;color:var(--neon);font-weight:800;font-size:2.4rem;text-shadow:0 0 20px rgba(0,234,255,0.12)}
.container{width:92%;max-width:1400px;margin:0 auto}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:28px}
.card{background:var(--card);padding:22px;border-radius:16px;backdrop-filter:blur(8px);box-shadow:0 6px 30px rgba(0,0,0,0.6);transition:transform .26s}
.card:hover{transform:translateY(-6px)}
.card h4{margin:0;font-size:0.95rem;color:var(--muted)}
.card .value{margin-top:10px;font-size:1.9rem;font-weight:800}
.row{display:flex;gap:20px;align-items:stretch}
.left{flex:2}
.right{flex:1}
.section{background:var(--card);padding:18px;border-radius:14px;margin-bottom:20px}
.canvas-wrap{height:300px}
.controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.primary{background:var(--neon);color:#001;box-shadow:0 6px 18px rgba(0,234,255,0.08)}
#predictionBox{border-left:4px solid var(--accent)}
.alert{position:fixed;right:18px;top:18px;padding:14px 18px;border-radius:10px;background:#111;box-shadow:0 8px 30px rgba(0,0,0,0.6);z-index:9999;display:none}
.status-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px}
.green{background:#19d37c}
.yellow{background:#ffd166}
.red{background:#ff4d6d}
.purple{background:#b84cff}
.footer{padding:22px;text-align:center;color:var(--muted)}
#particles-js{position:fixed;left:0;top:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:0.18}
.content{position:relative;z-index:1;padding-bottom:60px}
.download{margin-left:auto}
</style>
</head>
<body>
<header>Premium Air Quality Dashboard — Professional</header>
<div id="particles-js"></div>
<div class="container content">

  <div class="cards">
    <div class="card">
      <h4>Device</h4>
      <div class="value"><span id="deviceId">esp32-001</span> <small style="opacity:.6">•</small> <span id="connStatusText">Connecting...</span></div>
      <div style="margin-top:10px"><span id="connDot" class="status-dot yellow"></span> <small id="lastSeen">Last update: --</small></div>
    </div>
    <div class="card">
      <h4>AQI Status</h4>
      <div id="statusCard" class="value">--</div>
    </div>
    <div class="card">
      <h4>Temperature</h4>
      <div id="tempCard" class="value">-- °C</div>
    </div>
    <div class="card">
      <h4>Humidity</h4>
      <div id="humCard" class="value">-- %</div>
    </div>
    <div class="card">
      <h4>Gas PPM</h4>
      <div id="ppmCard" class="value">--</div>
    </div>
  </div>

  <div class="row">
    <div class="left">
      <div class="section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <h3 style="margin:0">Live Trends</h3>
          <div>
            <button class="btn" id="btnPPM">PPM</button>
            <button class="btn" id="btnTemp">Temp</button>
            <button class="btn" id="btnHum">Hum</button>
            <button class="btn" id="btnAll">Show All</button>
            <button class="btn primary" id="downloadCsv">Download CSV</button>
          </div>
        </div>
        <div class="canvas-wrap"><canvas id="liveChart"></canvas></div>
      </div>

      <div class="section">
        <h3 style="margin-top:0">Historical Data</h3>
        <div class="controls">
          <label class="muted">Range:</label>
          <select id="histRange" class="btn">
            <option value="24">Last 24 hours</option>
            <option value="168">Last 7 days</option>
          </select>
          <button class="btn" id="loadHistory">Load</button>
          <small style="margin-left:10px;color:var(--muted)">(Fetched from Firebase)</small>
        </div>
        <div class="canvas-wrap"><canvas id="histChart"></canvas></div>
      </div>
    </div>

    <div class="right">
      <div id="predictionBox" class="section">
        <h3 style="margin:0 0 10px 0">Prediction & Advice</h3>
        <div id="predictionText">Waiting for data…</div>
        <div style="margin-top:14px;color:var(--muted);font-size:.9rem">Health advice will appear here based on forecasted AQI.</div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 10px 0">Alerts</h3>
        <div><label><input type="checkbox" id="enableVoice" checked/> Enable voice alerts</label></div>
        <div style="margin-top:8px"><label><input type="checkbox" id="enableOnScreen" checked/> On-screen popups</label></div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 10px 0">Quick Health Recommendations</h3>
        <ul id="healthList" style="margin:0;padding-left:18px;color:var(--muted)"></ul>
      </div>
    </div>
  </div>

</div>

<div class="alert" id="alertBox"></div>

<div class="footer">© 2025 — Premium AQI Dashboard</div>

<script>
// ---------------- FIREBASE CONFIG (REPLACE with yours) ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDExWY6TkAItsbj7bG5KlGy4Ehvn21Qojw",
  authDomain: "esp32-airquality-monitor.firebaseapp.com",
  databaseURL: "https://esp32-airquality-monitor-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esp32-airquality-monitor",
  storageBucket: "esp32-airquality-monitor.firebasestorage.app",
  messagingSenderId: "793658380467",
  appId: "1:793658380467:web:5c84e543afa345c13520c6"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const DEVICE_ID = 'esp32-001';
const REF = `devices/${DEVICE_ID}/readings`;

// ---------------- Utilities ----------------
function showAlert(msg, colorClass=''){
  const el = document.getElementById('alertBox');
  el.innerText = msg; el.style.display='block';
  el.className = 'alert';
  if(colorClass) el.style.borderLeft = `6px solid ${colorClass}`;
  setTimeout(()=> el.style.display='none', 6000);
}

function speak(text){ if(!document.getElementById('enableVoice').checked) return; try{ speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }catch(e){}
}

function formatISO(ts){ return ts.replace('T',' ').replace(/_/g,':'); }

// ---------------- State ----------------
let liveMode = 'ppm'; // ppm | temp | hum | all
let liveHistory = [];
let lastTimestamp = null;
let connected = false;

// ---------------- Charts: liveChart shows selectable series ----------------
const liveCtx = document.getElementById('liveChart').getContext('2d');
const liveChart = new Chart(liveCtx, {
  type:'line', data:{ labels:[], datasets:[
    { label:'Gas PPM', data:[], borderColor:'#00eaff', tension:0.3, hidden:false },
    { label:'Temperature °C', data:[], borderColor:'#ff9800', tension:0.3, hidden:true },
    { label:'Humidity %', data:[], borderColor:'#00ff88', tension:0.3, hidden:true }
  ] }, options:{ plugins:{legend:{labels:{color:'#fff'}}}, scales:{ x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} }
});

const histCtx = document.getElementById('histChart').getContext('2d');
const histChart = new Chart(histCtx, { type:'line', data:{ labels:[], datasets:[{label:'AQI (PPM)', data:[], borderColor:'#b84cff', tension:0.25}]}, options:{scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}}, plugins:{legend:{labels:{color:'#fff'}}} } });

// ---------------- Color mapping (Global AQI theme) ----------------
function aqiColor(ppm){
  // example thresholds — tune to your calibration
  if(ppm < 80) return {label:'Good', color:'#19d37c', health:'Low risk. Normal activities.'};
  if(ppm < 150) return {label:'Moderate', color:'#ffd166', health:'Reduce prolonged outdoor exertion.'};
  if(ppm < 250) return {label:'Unhealthy', color:'#ff4d6d', health:'Avoid long outdoor activity.'};
  return {label:'Hazardous', color:'#b84cff', health:'Stay indoors; use masks/air purifiers.'};
}

// ---------------- Update UI ----------------
function updateCards(obj){
  document.getElementById('tempCard').innerText = obj.temperature + ' °C';
  document.getElementById('humCard').innerText = obj.humidity + ' %';
  document.getElementById('ppmCard').innerText = obj.gas_ppm;
  const meta = aqiColor(obj.gas_ppm);
  document.getElementById('statusCard').innerText = meta.label;
  document.getElementById('statusCard').style.color = meta.color;
  document.getElementById('connStatusText').innerText = connected ? 'Online' : 'Offline';
  document.getElementById('lastSeen').innerText = 'Last update: ' + new Date().toLocaleString();
  document.getElementById('connDot').className = 'status-dot ' + (meta.label==='Good'?'green':meta.label==='Moderate'?'yellow':meta.label==='Unhealthy'?'red':'purple');

  // health list
  const list = document.getElementById('healthList'); list.innerHTML='';
  const items = [meta.health, 'If you have respiratory conditions, keep inhaler/meds handy.', 'Consider indoor purifier when AQI is high.'];
  items.forEach(i=>{ const li=document.createElement('li'); li.innerText=i; list.appendChild(li); });
}

// ---------------- Real-time listener (last N readings) ----------------
firebase.database().ref(REF).limitToLast(1).on('child_added', snap=>{
  const val = snap.val(); if(!val) return;
  connected = true;
  lastTimestamp = snap.key || new Date().toISOString();
  liveHistory.push({ts:lastTimestamp, ...val});
  if(liveHistory.length>200) liveHistory.shift();

  // push to liveChart datasets
  const tLabel = new Date().toLocaleTimeString();
  liveChart.data.labels.push(tLabel);
  liveChart.data.datasets[0].data.push(val.gas_ppm);
  liveChart.data.datasets[1].data.push(val.temperature);
  liveChart.data.datasets[2].data.push(val.humidity);
  if(liveChart.data.labels.length>50){ liveChart.data.labels.shift(); liveChart.data.datasets.forEach(d=>d.data.shift()); }
  liveChart.update();

  // update cards
  updateCards(val);

  // push to history for prediction
  if(liveHistory.length>0){
    // move last gas_ppm into simple array for prediction
    const ppmArr = liveHistory.map(x=>parseFloat(x.gas_ppm));
    // trigger prediction
    runForecast(ppmArr);
  }

  // alerts
  const meta = aqiColor(val.gas_ppm);
  if(val.gas_ppm > 150){
    if(document.getElementById('enableOnScreen').checked) showAlert('High AQI: '+meta.label, meta.color);
    speak('Warning. Air quality is '+meta.label);
  }
});

// ---------------- Buttons to toggle live series ----------------
document.getElementById('btnPPM').addEventListener('click', ()=>{ liveChart.data.datasets[0].hidden=false; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=true; liveChart.update(); });
document.getElementById('btnTemp').addEventListener('click', ()=>{ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=false; liveChart.data.datasets[2].hidden=true; liveChart.update(); });
document.getElementById('btnHum').addEventListener('click', ()=>{ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=false; liveChart.update(); });
document.getElementById('btnAll').addEventListener('click', ()=>{ liveChart.data.datasets.forEach(d=>d.hidden=false); liveChart.update(); });

// ---------------- Download CSV ----------------
function downloadCSV(){
  if(liveHistory.length===0){ showAlert('No data to download'); return; }
  // CSV headers
  const headers = ['timestamp','temperature_c','humidity_pct','mq135_raw_or_ppm','aqi_est_status'];
  const rows = liveHistory.map(r=>[r.ts||'', r.temperature, r.humidity, r.gas_ppm, r.status||'']);
  let csv = headers.join(',')+'
';
  rows.forEach(r=>{ csv += r.map(v=>('"'+String(v).replace(/"/g,'""')+'"')).join(',')+'
'; });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `${DEVICE_ID}_data.csv`; a.click(); URL.revokeObjectURL(url);
}
document.getElementById('downloadCsv').addEventListener('click', downloadCSV);

// ---------------- Historical Data loader ----------------
document.getElementById('loadHistory').addEventListener('click', async ()=>{
  const hours = parseInt(document.getElementById('histRange').value,10);
  await loadHistorical(hours);
});

async function loadHistorical(hours){
  // compute timestamp cutoff
  const cutoff = Date.now() - hours*60*60*1000;
  // fetch all readings and filter (careful with large datasets)
  const snap = await firebase.database().ref(REF).once('value');
  const data = snap.val(); if(!data){ showAlert('No historical data'); return; }
  const items = Object.keys(data).map(k=>({ts:k, ...data[k]}));
  const filtered = items.filter(it=>{ const ts = Date.parse(it.ts.replace(/_/g,':').replace('T',' ')); return !isNaN(ts) && ts>=cutoff; });
  filtered.sort((a,b)=>Date.parse(a.ts)-Date.parse(b.ts));
  histChart.data.labels = filtered.map(x=> (new Date(x.ts.replace(/_/g,':').replace('T',' '))).toLocaleString());
  histChart.data.datasets[0].data = filtered.map(x=>parseFloat(x.gas_ppm));
  histChart.update();
  showAlert('Loaded '+filtered.length+' historical points');
}

// ---------------- Simple ML Forecast (linear regression) ----------------
function linearRegressionPredict(arr, forwardSteps=6){
  // arr: numeric array (recent ppm). We'll fit simple linear regression to last N points.
  const N = Math.min(20, arr.length);
  if(N<3) return null;
  const xs = []; const ys = [];
  for(let i=0;i<N;i++){ xs.push(i); ys.push(arr[arr.length-N+i]); }
  const xMean = xs.reduce((a,b)=>a+b,0)/N; const yMean = ys.reduce((a,b)=>a+b,0)/N;
  let num=0, den=0; for(let i=0;i<N;i++){ num += (xs[i]-xMean)*(ys[i]-yMean); den += (xs[i]-xMean)*(xs[i]-xMean); }
  const m = den===0?0:num/den; const c = yMean - m*xMean;
  // predict forwardSteps (each step is the data sampling interval)
  const nextX = N + forwardSteps; const pred = m*nextX + c; return Math.max(0, Math.round(pred));
}

function runForecast(ppmArr){
  const pred = linearRegressionPredict(ppmArr, 6); if(pred===null) return;
  const meta = aqiColor(pred);
  document.getElementById('predictionText').innerHTML = `<strong>Next ~30-60 min forecast:</strong><br>Predicted AQI (approx): <span style="color:${meta.color};font-weight:800">${pred}</span><br><em>${meta.health}</em>`;
}

// ---------------- Animated device connection indicator ----------------
function setConnection(online){
  connected = online;
  document.getElementById('connStatusText').innerText = online?'Online':'Offline';
  document.getElementById('connDot').className = 'status-dot ' + (online? 'green':'yellow');
}

// ---------------- Initialize particles and GSAP subtle entrance ----------------
particlesJS('particles-js', { particles:{ number:{value:60}, color:{value:'#00eaff'}, opacity:{value:0.8}, size:{value:3}}, interactivity:{detect_on:'canvas'} });
gsap.from('.card',{y:20,opacity:0,duration:0.8,stagger:0.06});

// ---------------- Initial historical load (24h) ----------------
loadHistorical(24);

// ---------------- Detect connection using last update time ----------------
setInterval(()=>{
  if(!lastTimestamp) { setConnection(false); return; }
  const last = Date.parse(lastTimestamp.replace(/_/g,':').replace('T',' '));
  if(isNaN(last)){ setConnection(false); return; }
  const diff = Date.now() - last;
  setConnection(diff < 120000); // online if last update within 2 minutes
}, 5000);

</script>
</body>
</html>
