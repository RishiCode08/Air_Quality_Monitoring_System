<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARTIFEX AQI - YOUR AIR, YOUR ACTION</title>

  <!-- PWA / Add to home screen -->
  <meta name="theme-color" content="#000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ARTIFEX AQI" />
  <link rel="icon" href="data:,">
  <!-- optional manifest: you can host /manifest.json later for full PWA behavior -->

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Chart.js + zoom plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

  <!-- TensorFlow.js (optional LSTM) - will be used only if TF_MODEL_URL set -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>

  <!-- helpers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root{
      --bg:#050505; --card:rgba(255,255,255,0.04);
      --neon:#00eaff; --accent:#00ff88; --muted:#9aa3b2;
      --cyber-purple:#b84cff; --glass: rgba(255,255,255,0.02);
      --radius:12px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#040404,#07070a);color:#fff;-webkit-font-smoothing:antialiased}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;gap:12px;background:radial-gradient(circle at 0 0, rgba(0,234,255,0.04), transparent 40%);backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,0.02)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#00eaff,#00ff88);display:flex;align-items:center;justify-content:center;color:#001;font-weight:900;box-shadow:0 8px 28px rgba(0,234,255,0.06)}
    .brand .title{font-weight:800;color:var(--neon);font-size:clamp(16px,2.2vw,22px)}
    .container{width:94%;max-width:1300px;margin:18px auto}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .small{color:var(--muted);font-size:0.9rem}
    .title{color:var(--muted);font-size:0.85rem}
    .value{font-weight:800;font-size:clamp(16px,2.6vw,28px);margin-top:6px}
    .section{background:var(--card);padding:14px;border-radius:var(--radius)}
    .canvas-wrap{height:320px;border-radius:10px;overflow:hidden;position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--neon);color:#001;box-shadow:0 8px 28px rgba(0,234,255,0.06)}
    .neon-select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:#fff}
    .live-indicator{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:10px;color:var(--neon);font-weight:700;z-index:20}
    .prediction-card{display:flex;flex-direction:column;gap:6px}
    .prediction-score{font-size:1.8rem;font-weight:900}
    .health-card{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(184,76,255,0.06), rgba(0,0,0,0.04));}
    .comparison-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .footer{padding:16px;text-align:center;color:var(--muted);font-size:0.9rem;margin-top:18px}

    @media (max-width:1100px){
      .grid{grid-template-columns:repeat(6,1fr)}
      .card{grid-column:span 3}
      .section{grid-column:span 6}
    }
    @media (max-width:700px){
      .grid{grid-template-columns:repeat(1,1fr)}
      .card{grid-column:span 1}
      .section{grid-column:span 1}
      .canvas-wrap{height:240px}
      .brand .title{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">ART</div>
      <div>
        <div class="title">ARTIFEX AQI — YOUR AIR, YOUR ACTION</div>
        <div class="small">Real-time Air Intelligence — Responsive, Neon Cyber UI</div>
      </div>
    </div>
    <div>
      <button class="btn" id="shareBtn">Share</button>
      <button class="btn" id="installPromptBtn" style="display:none">Install App</button>
    </div>
  </div>

  <div class="container">
    <!-- top stat cards -->
    <div class="grid" style="margin-bottom:12px">
      <div class="card" style="grid-column:span 3">
        <div class="title">Device</div>
        <div class="value"><span id="deviceId">AIR-SENSE-PRO</span> · <small id="connStatus" class="small">Connecting...</small></div>
        <div style="margin-top:8px" class="small"><span id="connDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ffd166;margin-right:8px"></span><span id="lastSeen">Last: --</span></div>
      </div>

      <div class="card" style="grid-column:span 3">
        <div class="title">AQI Status</div>
        <div id="statusCard" class="value">--</div>
      </div>

      <div class="card" style="grid-column:span 3">
        <div class="title">Temperature</div>
        <div id="tempCard" class="value">-- °C</div>
      </div>

      <div class="card" style="grid-column:span 3">
        <div class="title">Humidity</div>
        <div id="humCard" class="value">-- %</div>
      </div>
    </div>

    <!-- main row -->
    <div class="grid" style="align-items:start;gap:12px">
      <!-- Live trends -->
      <div class="section" style="grid-column:span 8">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h3 style="margin:0">Live Trends</h3>
          <div class="controls">
            <button class="btn" id="btnPPM">PPM</button>
            <button class="btn" id="btnTemp">Temp</button>
            <button class="btn" id="btnHum">Hum</button>
            <button class="btn" id="btnAll">Show All</button>
            <button class="btn primary" id="downloadCsv">Download CSV</button>
          </div>
        </div>
        <div class="canvas-wrap">
          <div id="liveIndicator" class="live-indicator">Live: PPM</div>
          <canvas id="liveChart"></canvas>
        </div>
      </div>

      <!-- right column: prediction + health -->
      <div style="grid-column:span 4;display:flex;flex-direction:column;gap:12px">
        <div class="card prediction-card">
          <div class="title">1-Hour AQI Forecast</div>
          <div id="oneHourScore" class="prediction-score">--</div>
          <div id="oneHourAdvice" class="small">Waiting for data…</div>
          <div style="margin-top:6px" class="small">Forecast method: <span id="forecastMethod">Linear Regression (fallback)</span></div>
        </div>

        <div class="card health-card">
          <div class="title">Health Recommendation (Dynamic)</div>
          <div id="healthDynamic" style="margin-top:8px">
            <div style="font-weight:800">--</div>
            <div class="small" id="healthDetail">Tracking live AQI to provide tailored advice.</div>
          </div>
        </div>

        <div class="card">
          <div class="title">Alerts & Customization</div>
          <div style="margin-top:8px">
            <label class="small"><input id="enableOnScreen" type="checkbox" checked/> On-screen alert</label><br>
            <label class="small"><input id="enableVoice" type="checkbox" checked/> Voice alert</label>
            <div style="margin-top:8px" class="small">Custom thresholds:</div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <input id="threshPPM" type="number" placeholder="PPM" style="padding:6px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.04);color:#fff;width:80px"/>
              <input id="threshTemp" type="number" placeholder="Temp°C" style="padding:6px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.04);color:#fff;width:80px"/>
              <input id="threshHum" type="number" placeholder="Hum%" style="padding:6px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.04);color:#fff;width:80px"/>
            </div>
            <div style="margin-top:8px"><button class="btn" id="saveThresholds">Save</button></div>
          </div>
        </div>
      </div>
    </div>

    <!-- historical + comparison -->
    <div class="section" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Historical & Comparison</h3>
        <div class="comparison-controls">
          <div>
            <!-- custom themed dropdown -->
            <div style="position:relative;display:inline-block">
              <button id="rangeBtn" class="btn primary">Range: Last 24h ▾</button>
              <div id="rangeMenu" style="display:none;position:absolute;right:0;top:40px;background:var(--card);padding:8px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.6);min-width:220px;z-index:60">
                <div class="small" data-range="24h" style="padding:8px;border-radius:8px;cursor:pointer">Last 24 hours</div>
                <div class="small" data-range="today" style="padding:8px;border-radius:8px;cursor:pointer">Today (midnight → now)</div>
                <div class="small" data-range="yesterday" style="padding:8px;border-radius:8px;cursor:pointer">Yesterday</div>
                <div class="small" data-range="3days" style="padding:8px;border-radius:8px;cursor:pointer">Last 3 days</div>
                <div style="height:8px"></div>
                <div class="small" id="customRangeToggle" style="padding:8px;border-radius:8px;cursor:pointer">Custom range (picker)</div>
                <div id="customRangePanel" style="display:none;margin-top:8px">
                  <input id="customStart" placeholder="Start (YYYY-MM-DD HH:MM)" style="width:100%;padding:6px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.04);color:#fff"/>
                  <input id="customEnd" placeholder="End (YYYY-MM-DD HH:MM)" style="width:100%;margin-top:6px;padding:6px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.04);color:#fff"/>
                  <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="applyCustom">Apply</button><button class="btn" id="cancelCustom">Cancel</button></div>
                </div>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <select id="compareMetric" class="neon-select">
              <option value="aqi">AQI</option>
              <option value="temp">Temperature</option>
              <option value="hum">Humidity</option>
              <option value="overlay">AQI vs Temp vs Humidity</option>
            </select>
            <button class="btn" id="compareBtn">Compare</button>
          </div>
        </div>
      </div>

      <div class="canvas-wrap" style="margin-top:12px"><canvas id="histChart"></canvas></div>
    </div>

    <div class="footer">© 2025 — ARTIFEX AQI — Rishi Savani</div>
  </div>

  <div id="alertBox" class="card" style="position:fixed;right:18px;top:18px;display:none;z-index:1000"></div>

<script>
/* ================== CONFIG ================== */
/* Replace firebaseConfig with your config */
const firebaseConfig = {
  apiKey: "AIzaSyDExWY6TkAItsbj7bG5KlGy4Ehvn21Qojw",
  authDomain: "esp32-airquality-monitor.firebaseapp.com",
  databaseURL: "https://esp32-airquality-monitor-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esp32-airquality-monitor",
  storageBucket: "esp32-airquality-monitor.appspot.com",
  messagingSenderId: "793658380467",
  appId: "1:793658380467:web:5c84e543afa345c13520c6"
};
firebase.initializeApp(firebaseConfig);

/* Device id: change this to match your device key in Firebase */
const DEVICE_ID = 'AIR-SENSE-PRO';             // change here to match DB key
const REF = `devices/${DEVICE_ID}/readings`;

/* Optional: provide TF.js hosted model URL (must be hosted accessible via https)
   If you put a model (tfjs format) here, the page will attempt to use it. Otherwise fallback. */
const TF_MODEL_URL = null; // e.g. "https://yourdomain.com/models/aqi_lstm/model.json"

/* ================== Utilities ================== */
function showAlert(msg, color){
  const el = document.getElementById('alertBox');
  el.innerText = msg; el.style.display = 'block'; el.style.borderLeft = color?('6px solid '+color):'';
  setTimeout(()=>el.style.display='none',6000);
}
function speak(text){ if(!document.getElementById('enableVoice').checked) return; try{ speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }catch(e){} }

function parseKeyToMs(key){
  if(!key) return NaN;
  let s = String(key).trim().replace(/_/g,':');
  s = s.replace(/\s+T\s+/,'T').replace(/\s+/,'T');
  // fix if first ':' appears after date: 2025-11-22:12:00:00 -> replace first ':' with 'T'
  const parts = s.split(':');
  if(parts.length>2 && parts[0].indexOf('-')!==-1 && parts[0].indexOf('T')===-1){
    s = s.replace(/:/,'T');
  }
  const t = Date.parse(s);
  return isNaN(t)? NaN : t;
}

/* ================== State ================== */
let liveHistory = [];
let lastTimestamp = null;
let connected = false;
let histChart = null;
let liveChart = null;
let modelTF = null; // tf model if loaded

/* ================== Charts init ================== */
const liveCtx = document.getElementById('liveChart').getContext('2d');
liveChart = new Chart(liveCtx, {
  type:'line',
  data:{ labels:[], datasets:[
    {label:'Gas PPM', data:[], borderColor:'#00eaff', tension:0.25, pointRadius:2, borderWidth:2},
    {label:'Temperature °C', data:[], borderColor:'#ff9800', tension:0.25, pointRadius:2, borderWidth:2, hidden:true},
    {label:'Humidity %', data:[], borderColor:'#00ff88', tension:0.25, pointRadius:2, borderWidth:2, hidden:true}
  ]},
  options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}} }
});

const histCtx = document.getElementById('histChart').getContext('2d');
histChart = new Chart(histCtx, {
  type:'line',
  data:{ labels:[], datasets:[
    {label:'Series A', data:[], borderColor:'#b84cff', tension:0.25, pointRadius:2, borderWidth:2},
    {label:'Compare', data:[], borderColor:'#00eaff', tension:0.25, pointRadius:2, borderWidth:2, hidden:true}
  ]},
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{ display:false },
      zoom:{
        pan:{enabled:true, mode:'x'},
        zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' }
      }
    },
    scales:{ x:{ticks:{color:'#fff', autoSkip:true, maxTicksLimit:8}}, y:{ticks:{color:'#fff'}} }
  }
});

/* ================== AQI meta + dynamic health card ================== */
function aqiMeta(ppm){
  ppm = Number(ppm) || 0;
  if(ppm < 80) return {label:'Good', color:'#19d37c', health:'Low risk. Normal activities.', adv: 'Enjoy outdoor activities.'};
  if(ppm < 150) return {label:'Moderate', color:'#ffd166', health:'Reduce prolonged outdoor exertion.', adv: 'Limit long outdoor exercise.'};
  if(ppm < 250) return {label:'Unhealthy', color:'#ff4d6d', health:'Avoid long outdoor activity.', adv: 'Use mask; avoid strenuous activity.'};
  return {label:'Hazardous', color:'#b84cff', health:'Stay indoors; use masks/air purifiers.', adv: 'Immediate precautions: stay inside.'};
}

function updateCards(obj){
  document.getElementById('tempCard').innerText = (obj.temperature!==undefined ? obj.temperature : '--') + ' °C';
  document.getElementById('humCard').innerText = (obj.humidity!==undefined ? obj.humidity : '--') + ' %';
  const meta = aqiMeta(obj.gas_ppm);
  document.getElementById('statusCard').innerText = meta.label;
  document.getElementById('statusCard').style.color = meta.color;
  document.getElementById('connStatus').innerText = connected ? 'Online' : 'Offline';
  document.getElementById('lastSeen').innerText = lastTimestamp ? new Date(parseKeyToMs(lastTimestamp)).toLocaleString() : '--';

  // dynamic health card display (rotating suggestions)
  const pool = [
    meta.adv,
    'Stay hydrated and avoid outdoor cooking.',
    'Check indoor ventilation; run purifier if available.',
    'If symptoms occur, contact medical help.'
  ];
  const extra = pool[Math.floor(Math.random()*pool.length)];
  document.getElementById('healthDynamic').innerHTML = `<div style="font-weight:900;color:${meta.color}">${meta.label}</div><div class="small" id="healthDetail">${meta.health} — ${extra}</div>`;
}

/* ================== Forecasting block ================== */
/* linear regression fallback */
function linearPredict(arr, forwardSteps=6){
  const N = Math.min(20, (arr||[]).length);
  if(N < 3) return null;
  const xs = [], ys = [];
  for(let i=0;i<N;i++){ xs.push(i); ys.push(arr[arr.length - N + i]); }
  const xMean = xs.reduce((a,b)=>a+b,0)/N; const yMean = ys.reduce((a,b)=>a+b,0)/N;
  let num=0, den=0;
  for(let i=0;i<N;i++){ num += (xs[i]-xMean)*(ys[i]-yMean); den += (xs[i]-xMean)*(xs[i]-xMean); }
  const m = den===0?0:num/den; const c = yMean - m*xMean;
  const pred = m*(N + forwardSteps) + c;
  return Math.max(0, Math.round(pred));
}

/* TF.js LSTM predictor (will run only if TF_MODEL_URL is set and accessible)
   Expectation: model takes normalized sequence and outputs numeric AQI prediction.
   This code is a template — adapt preprocessing to your model's expected input. */
async function tfPredictOneHour(seq){ // seq = recent ppm array
  if(!TF_MODEL_URL) return null;
  try{
    if(!modelTF){ modelTF = await tf.loadLayersModel(TF_MODEL_URL); document.getElementById('forecastMethod').innerText = 'TF LSTM Model'; }
    // prepare input: this depends on your model. Here we assume [1, time_steps, 1] input and values scaled 0..1
    const timeSteps = Math.min(50, seq.length);
    const arr = seq.slice(-timeSteps).map(x=>Number(x)||0);
    const maxVal = Math.max(...arr, 1);
    const norm = arr.map(v => v / maxVal);
    const input = tf.tensor(norm).reshape([1, norm.length, 1]);
    const out = modelTF.predict(input);
    const pred = (await out.data())[0] * maxVal;
    tf.dispose([input, out]);
    return Math.round(pred);
  }catch(e){ console.warn('TF predict failed:', e); return null; }
}

/* run forecast and update 1-hour card */
async function updateForecast(ppmArr){
  // prefer TF if available
  let pred = null;
  if(TF_MODEL_URL) pred = await tfPredictOneHour(ppmArr);
  if(pred === null) pred = linearPredict(ppmArr, 6); // fallback
  if(pred === null) return;
  const meta = aqiMeta(pred);
  document.getElementById('oneHourScore').innerText = pred;
  document.getElementById('oneHourAdvice').innerText = meta.health;
  // also fill health card for next hour
  document.getElementById('predictionMethod')?.remove?.();
}

/* ================== Real-time listener (safe) ================== */
firebase.database().ref(REF).limitToLast(1).on('child_added', async snap => {
  try{
    const val = snap.val(); if(!val) return;
    connected = true;
    lastTimestamp = snap.key || new Date().toISOString();

    // push to history
    liveHistory.push({ts:lastTimestamp, ...val});
    if(liveHistory.length > 2000) liveHistory.shift();

    // ensure liveChart ready
    if(!liveChart || !liveChart.data) return;

    const tLabel = new Date().toLocaleTimeString();
    liveChart.data.labels.push(tLabel);
    liveChart.data.datasets[0].data.push(Number(val.gas_ppm) || 0);
    liveChart.data.datasets[1].data.push(Number(val.temperature) || 0);
    liveChart.data.datasets[2].data.push(Number(val.humidity) || 0);

    if(liveChart.data.labels.length > 60){
      liveChart.data.labels.shift();
      liveChart.data.datasets.forEach(d=>d.data.shift());
    }
    liveChart.update();

    updateCards(val);

    // forecast using recent ppm
    const ppmArr = liveHistory.slice(-40).map(x => Number(x.gas_ppm) || 0);
    await updateForecast(ppmArr);

    // alerts
    const meta = aqiMeta(val.gas_ppm);
    const customPPM = Number(document.getElementById('threshPPM').value) || null;
    if((customPPM && val.gas_ppm >= customPPM) || val.gas_ppm > 150){
      if(document.getElementById('enableOnScreen').checked) showAlert('High AQI: '+meta.label, meta.color);
      if(document.getElementById('enableVoice').checked) speak('Warning. Air quality is '+meta.label);
    }
  }catch(e){
    console.error('Realtime callback error:', e);
  }
});

/* ================== Live series toggles ================== */
function setLiveMode(mode){
  if(!liveChart) return;
  if(mode === 'ppm'){ liveChart.data.datasets[0].hidden=false; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=true; document.getElementById('liveIndicator').innerText='Live: PPM'; }
  if(mode === 'temp'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=false; liveChart.data.datasets[2].hidden=true; document.getElementById('liveIndicator').innerText='Live: Temperature'; }
  if(mode === 'hum'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=false; document.getElementById('liveIndicator').innerText='Live: Humidity'; }
  if(mode === 'all'){ liveChart.data.datasets.forEach(ds=>ds.hidden=false); document.getElementById('liveIndicator').innerText='Live: All Sensors'; }
  liveChart.update();
}
document.getElementById('btnPPM').addEventListener('click', ()=>setLiveMode('ppm'));
document.getElementById('btnTemp').addEventListener('click', ()=>setLiveMode('temp'));
document.getElementById('btnHum').addEventListener('click', ()=>setLiveMode('hum'));
document.getElementById('btnAll').addEventListener('click', ()=>setLiveMode('all'));

/* ================== CSV download ================== */
document.getElementById('downloadCsv').addEventListener('click', ()=>{
  if(liveHistory.length===0){ showAlert('No data to download'); return; }
  const headers = ['timestamp','temperature_c','humidity_pct','mq135_ppm','aqi_status'];
  const rows = liveHistory.map(r=>[r.ts||'', r.temperature, r.humidity, r.gas_ppm, r.status||'']);
  let csv = headers.join(',') + '\n';
  rows.forEach(r => { csv += r.map(v => ('"' + String(v).replace(/"/g,'""') + '"')).join(',') + '\n'; });
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${DEVICE_ID}_data.csv`; a.click(); URL.revokeObjectURL(url);
});

/* ================== Historical loader & comparison ================== */
async function loadRange(startMs, endMs, metric='aqi', compareWith=null){
  try{
    const snap = await firebase.database().ref(REF).once('value');
    const data = snap.val();
    if(!data){ showAlert('No historical data'); return; }
    const items = Object.keys(data).map(k=>({ts:k, ...data[k]}));
    const filtered = items.filter(it=>{ const t = parseKeyToMs(it.ts); return !isNaN(t) && t>=startMs && t<=endMs; });
    filtered.sort((a,b)=> parseKeyToMs(a.ts)-parseKeyToMs(b.ts));

    // labels
    histChart.data.labels = filtered.map(x=> (new Date(parseKeyToMs(x.ts))).toLocaleString());

    // primary series
    if(metric === 'aqi') histChart.data.datasets[0].data = filtered.map(x=>Number(x.gas_ppm)||0);
    if(metric === 'temp') histChart.data.datasets[0].data = filtered.map(x=>Number(x.temperature)||0);
    if(metric === 'hum') histChart.data.datasets[0].data = filtered.map(x=>Number(x.humidity)||0);

    histChart.data.datasets[0].label = metric==='aqi' ? 'AQI (PPM)' : metric==='temp' ? 'Temperature (°C)' : 'Humidity (%)';
    histChart.update();

    // compareWith = 'yesterday' or 'prev' -> compute compare series aligned by time-of-day (simple approach)
    if(compareWith === 'yesterday'){
      // create time-of-day mapping for yesterday
      const yesterdayStart = startMs - 24*3600*1000;
      const yesterdayEnd = endMs - 24*3600*1000;
      const yFiltered = items.filter(it=>{ const t = parseKeyToMs(it.ts); return !isNaN(t) && t>=yesterdayStart && t<=yesterdayEnd;});
      // simple alignment: map by index (if different lengths, pad)
      const ySorted = yFiltered.sort((a,b)=>parseKeyToMs(a.ts)-parseKeyToMs(b.ts));
      const yVals = metric==='aqi' ? ySorted.map(x=>Number(x.gas_ppm)||0) : metric==='temp' ? ySorted.map(x=>Number(x.temperature)||0) : ySorted.map(x=>Number(x.humidity)||0);
      // try align lengths
      const L = histChart.data.labels.length;
      const yAligned = Array.from({length:L}, (_,i)=> yVals[Math.floor(i * (yVals.length || 1) / (L || 1))] || 0);
      histChart.data.datasets[1].data = yAligned;
      histChart.data.datasets[1].hidden = false;
      histChart.update();
      showAlert('Comparison: current range vs Yesterday');
    } else {
      histChart.data.datasets[1].hidden = true;
      histChart.update();
    }

  }catch(e){ console.error(e); showAlert('Historical load error: '+e.message); }
}

/* UI: range menu wiring */
const rangeBtn = document.getElementById('rangeBtn');
const rangeMenu = document.getElementById('rangeMenu');
rangeBtn.addEventListener('click', ()=>{ rangeMenu.style.display = rangeMenu.style.display==='block' ? 'none' : 'block'; });

rangeMenu.querySelectorAll('[data-range]').forEach(el=>{
  el.addEventListener('click', async (evt)=>{
    const r = evt.currentTarget.getAttribute('data-range');
    rangeMenu.style.display='none';
    rangeBtn.innerText = 'Range: ' + (r==='24h' ? 'Last 24h' : r==='today' ? 'Today' : r==='yesterday' ? 'Yesterday' : 'Last 3 days') + ' ▾';
    if(r === '24h'){ const end = Date.now(); await loadRange(end - 24*3600*1000, end, document.getElementById('compareMetric').value); }
    if(r === 'today'){ const now = new Date(); const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime(); await loadRange(start, Date.now(), document.getElementById('compareMetric').value); }
    if(r === 'yesterday'){ const now = new Date(); const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1).getTime(); const end = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime(); await loadRange(start, end, document.getElementById('compareMetric').value, 'yesterday'); }
    if(r === '3days'){ const end = Date.now(); await loadRange(end - 3*24*3600*1000, end, document.getElementById('compareMetric').value); }
  });
});

/* custom range toggle */
document.getElementById('customRangeToggle').addEventListener('click', ()=> {
  const p = document.getElementById('customRangePanel'); p.style.display = p.style.display==='block' ? 'none':'block';
});
document.getElementById('cancelCustom').addEventListener('click', ()=>{ document.getElementById('customStart').value=''; document.getElementById('customEnd').value=''; document.getElementById('customRangePanel').style.display='none'; });
flatpickr('#customStart',{enableTime:true,dateFormat:'Y-m-d H:i'});
flatpickr('#customEnd',{enableTime:true,dateFormat:'Y-m-d H:i'});
document.getElementById('applyCustom').addEventListener('click', async ()=>{
  const s = document.getElementById('customStart').value; const e = document.getElementById('customEnd').value;
  if(!s||!e){ showAlert('Set both start and end'); return; }
  const startMs = Date.parse(s.replace(' ','T')); const endMs = Date.parse(e.replace(' ','T'));
  if(isNaN(startMs)||isNaN(endMs)){ showAlert('Invalid dates'); return; }
  document.getElementById('customRangePanel').style.display='none';
  await loadRange(startMs, endMs, document.getElementById('compareMetric').value);
});

/* compare button */
document.getElementById('compareBtn').addEventListener('click', ()=>{
  // reload using current visible range button label to detect which range -> easiest: default to last 24h
  const label = rangeBtn.innerText.toLowerCase();
  if(label.includes('24')) { loadRange(Date.now()-24*3600*1000, Date.now(), document.getElementById('compareMetric').value, 'yesterday'); }
  else { loadRange(Date.now()-24*3600*1000, Date.now(), document.getElementById('compareMetric').value, 'yesterday'); }
});

/* ================== zoom controls wiring */
document.getElementById('zoomInBtn').addEventListener('click', ()=>{ try{ histChart.zoom(1.2); }catch(e){ showAlert('Zoom not supported'); } });
document.getElementById('zoomOutBtn').addEventListener('click', ()=>{ try{ histChart.zoom(0.8); }catch(e){ showAlert('Zoom not supported'); } });
document.getElementById('resetZoomBtn').addEventListener('click', ()=>{ try{ histChart.resetZoom(); }catch(e){ showAlert('Reset zoom not supported'); } });

/* ================== thresholds saving */
document.getElementById('saveThresholds').addEventListener('click', ()=>{
  showAlert('Thresholds saved (temporary)', '#00eaff');
});

/* ================== install prompt (PWA) - basic */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e; const btn = document.getElementById('installPromptBtn'); btn.style.display='inline-block';
  btn.addEventListener('click', async ()=>{
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null; btn.style.display='none';
  });
});

/* ================== init cosmetic & default loads ================== */
gsap.from('.card',{y:12,opacity:0,duration:0.7,stagger:0.04});
loadRange(Date.now() - 24*3600*1000, Date.now(), 'aqi'); // load last 24h by default

/* Connection monitor */
setInterval(()=> {
  if(!lastTimestamp){ connected=false; setConnection(false); return; }
  const last = parseKeyToMs(lastTimestamp);
  if(isNaN(last)){ setConnection(false); return; }
  const diff = Date.now() - last;
  setConnection(diff < 120000);
},3000);
function setConnection(on){ connected=on; document.getElementById('connStatus').innerText = on ? 'Online' : 'Offline'; document.getElementById('connDot').style.background = on ? '#19d37c' : '#ffd166'; }

</script>
</body>
</html>
