<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ARTIFEX AQI - Plan Smarter, Breathe Safer</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<!-- Chart.js + zoom plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

<!-- TensorFlow.js for LSTM in-browser (lightweight) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>

<!-- small helpers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js"></script>
<link rel="manifest" href="#" id="manifestLink">

<style>
:root{
  --bg:#050505; --card:rgba(255,255,255,0.04); --neon:#00eaff; --accent:#00ff88; --muted:#9aa3b2;
  --glass: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#020204 0%, #050505 50%);color:#fff;-webkit-font-smoothing:antialiased}
.top{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,0.03);background:transparent}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#00eaff,#00ff88);display:flex;align-items:center;justify-content:center;font-weight:900;color:#002;font-size:16px;box-shadow:0 8px 36px rgba(0,234,255,0.06)}
.title{font-weight:800;color:var(--neon);font-size:clamp(16px,3.4vw,26px)}
.controls{display:flex;gap:8px;align-items:center}
.container{max-width:1200px;margin:18px auto;padding:0 18px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.card.small{padding:10px}
.cards-top{grid-column:span 12;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px}
.card .label{color:var(--muted);font-size:0.85rem}
.card .value{margin-top:8px;font-weight:800;font-size:1.4rem}
.section{grid-column:span 8;background:var(--card);padding:12px;border-radius:12px}
.side{grid-column:span 4;background:var(--card);padding:12px;border-radius:12px}
.canvas-wrap{height:340px;border-radius:10px;overflow:hidden;position:relative;background:linear-gradient(180deg, rgba(255,255,255,0.008), transparent)}
.live-indicator{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:10px;color:var(--neon);font-weight:700;z-index:20}
.aqi-pill{display:inline-block;padding:8px 12px;border-radius:999px;font-weight:800;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 40px rgba(184,76,255,0.06);color:var(--neon)}
.small-muted{color:var(--muted);font-size:0.9rem}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.btn.primary{background:var(--neon);color:#001;box-shadow:0 6px 18px rgba(0,234,255,0.06)}
.range-list{display:flex;gap:8px;flex-wrap:wrap}
.legend{display:flex;gap:8px;align-items:center}
.legend .dot{width:12px;height:12px;border-radius:50%}
.footer{padding:18px;text-align:center;color:var(--muted);margin-top:12px}

/* responsive */
@media (max-width:1000px){
  .section{grid-column:span 12}
  .side{grid-column:span 12}
  .canvas-wrap{height:260px}
}
@media (max-width:600px){
  .top{padding:10px}
  .title{font-size:18px}
  .canvas-wrap{height:220px}
}
</style>
</head>
<body>
  <div id="particles-js" style="position:fixed;left:0;top:0;width:100%;height:100%;z-index:0;opacity:0.08;pointer-events:none"></div>

  <div class="top">
    <div class="brand">
      <div class="logo">ART</div>
      <div>
        <div class="title">ARTIFEX AQI — YOUR AIR, YOUR ACTION</div>
        <div class="small-muted">Plan smarter — breathe safer (PWA + Live)</div>
      </div>
    </div>

    <div class="controls">
      <button id="installBtn" class="btn">Add to Home Screen</button>
      <button id="settingsBtn" class="btn">Alerts</button>
    </div>
  </div>

  <div class="container" style="position:relative;z-index:5">
    <div class="grid">
      <div class="cards-top">
        <div class="card small">
          <div class="label">Device</div>
          <div class="value"><span id="deviceId">AIR-SENSE-PRO</span> · <small id="connStatus">Connecting...</small></div>
          <div class="small-muted" style="margin-top:8px"><span id="connDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#ffd166;margin-right:8px"></span><span id="lastSeen">Last update: --</span></div>
        </div>

        <div class="card small">
          <div class="label">AQI Status</div>
          <div id="statusCard" class="value aqi-pill">--</div>
        </div>

        <div class="card small">
          <div class="label">Temperature</div>
          <div id="tempCard" class="value">-- °C</div>
        </div>

        <div class="card small">
          <div class="label">Humidity</div>
          <div id="humCard" class="value">-- %</div>
        </div>

        <div class="card small">
          <div class="label">Gas PPM</div>
          <div id="ppmCard" class="value">--</div>
        </div>
      </div>

      <!-- Live + side -->
      <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Live Trends</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="legend">
              <div class="dot" style="background:#00eaff"></div><div class="small-muted">PPM</div>
              <div class="dot" style="background:#ff9800;margin-left:10px"></div><div class="small-muted">Temp</div>
              <div class="dot" style="background:#00ff88;margin-left:10px"></div><div class="small-muted">Hum</div>
            </div>
            <button class="btn" id="btnPPM">PPM</button>
            <button class="btn" id="btnTemp">Temp</button>
            <button class="btn" id="btnHum">Hum</button>
            <button class="btn" id="btnAll">Show All</button>
            <button class="btn primary" id="downloadCsv">Download CSV</button>
          </div>
        </div>

        <div class="canvas-wrap">
          <div class="live-indicator" id="liveIndicator">Live: PPM</div>
          <canvas id="liveChart"></canvas>
        </div>
      </div>

      <div class="side">
        <div style="margin-bottom:10px">
          <h4 style="margin:0 0 8px 0">12-hour Forecast</h4>
          <div id="forecastPills" style="display:flex;gap:8px;flex-wrap:wrap"></div>
          <div id="predictionSummary" style="margin-top:10px;color:var(--muted)">Waiting for forecast...</div>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:0 0 8px 0">Trend</h4>
          <div id="trendBox" class="value">--</div>
          <div style="margin-top:10px;color:var(--muted)">Shows short-term trend (rising/stable/falling)</div>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:0 0 8px 0">Health Recommendations</h4>
          <ul id="healthList" style="margin:0;padding-left:18px;color:var(--muted)"></ul>
        </div>
      </div>

      <!-- Historical area -->
      <div class="section" style="grid-column:span 12; margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Historical & Comparison</h3>

          <div style="display:flex;gap:10px;align-items:center">
            <div class="range-list">
              <button class="btn" onclick="setRange('today')">Today</button>
              <button class="btn" onclick="setRange('yesterday')">Yesterday</button>
              <button class="btn" onclick="setRange('3days')">Last 3 days</button>
              <button class="btn" onclick="setRange('24h')">Last 24h</button>
            </div>

            <select id="metricCompare" class="btn">
              <option value="ppm">AQI (PPM)</option>
              <option value="temp">Temperature</option>
              <option value="hum">Humidity</option>
            </select>

            <button class="btn" id="zoomInBtn">Zoom In</button>
            <button class="btn" id="zoomOutBtn">Zoom Out</button>
            <button class="btn" id="resetZoomBtn">Reset Zoom</button>
          </div>
        </div>

        <div style="margin-top:12px" class="canvas-wrap">
          <canvas id="histChart"></canvas>
        </div>
      </div>
    </div>

    <div class="footer">© 2025 — ARTIFEX - RISHI SAVANI</div>
  </div>

  <div id="alertBox" style="position:fixed;right:18px;top:18px;padding:14px 18px;border-radius:10px;background:#111;display:none;z-index:9999"></div>

<script>
/* ================== CONFIG — replace with your Firebase config ================== */
const firebaseConfig = {
   apiKey: "AIzaSyDExWY6TkAItsbj7bG5KlGy4Ehvn21Qojw",
  authDomain: "esp32-airquality-monitor.firebaseapp.com",
  databaseURL: "https://esp32-airquality-monitor-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esp32-airquality-monitor",
  storageBucket: "esp32-airquality-monitor.appspot.com",
  messagingSenderId: "793658380467",
  appId: "1:793658380467:web:5c84e543afa345c13520c6"
};
firebase.initializeApp(firebaseConfig);

/* ================== Settings ================== */
const DEVICE_ID = 'AIR-SENSE-PRO';
const REF = `devices/${DEVICE_ID}/readings`;

/* ================== Helpers/UI ================== */
function showAlert(msg, color='#ffd166'){ const el=document.getElementById('alertBox'); el.innerText=msg; el.style.display='block'; el.style.borderLeft=`6px solid ${color}`; setTimeout(()=>el.style.display='none',6000); }
function speak(text){ if(!document.getElementById('enableVoice')?.checked) return; try{ speechSynthesis.cancel(); speechSynthesis.speak(new SpeechSynthesisUtterance(text)); }catch(e){} }

/* particles background */
particlesJS('particles-js', { particles: { number: { value: 50 }, color: { value: '#00eaff' }, opacity: { value: 0.6 }, size: { value: 2 } }, interactivity: { detect_on: 'canvas' } });

/* ================== State ================== */
let liveHistory = []; let lastTimestamp = null; let connected = false;
let userThresholds = { ppm: 150, temp: 45, hum: 80 }; // defaults; user can customize (we'll open a minimal panel)
let forecastModel = null; // tf model
let forecastIntervalMs = null; // we will derive sampling interval based on data cadence

/* robust timestamp parser (accept many esp32 formats) */
function parseTS(tsKey){
  if(!tsKey) return NaN;
  let s = String(tsKey).trim().replace(/_/g,':'); // replace underscores => :
  s = s.replace(/\s+T\s+/,'T'); s = s.replace(/\s+/,'T'); // space => T
  const parts = s.split(':'); if(parts.length>2 && parts[0].indexOf('-')!==-1 && parts[0].indexOf('T')===-1) s = s.replace(/:/,'T');
  const t = Date.parse(s); return isNaN(t)?NaN:t;
}

/* ================== Charts init (live + hist + comparison overlay) ================== */
const liveCtx = document.getElementById('liveChart').getContext('2d');
const liveChart = new Chart(liveCtx, {
  type:'line',
  data:{ labels:[], datasets:[
    { label:'Gas PPM', data:[], borderColor:'#00eaff', tension:0.35, pointRadius:2, borderWidth:2 },
    { label:'Temp (°C)', data:[], borderColor:'#ff9800', tension:0.35, pointRadius:2, borderWidth:2, hidden:true },
    { label:'Hum (%)', data:[], borderColor:'#00ff88', tension:0.35, pointRadius:2, borderWidth:2, hidden:true }
  ]},
  options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} }, scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } } } }
});

const histCtx = document.getElementById('histChart').getContext('2d');
const histChart = new Chart(histCtx, {
  type:'line',
  data:{ labels:[], datasets:[
    { label:'Main', data:[], borderColor:'#b84cff', tension:0.25, pointRadius:2, borderWidth:2 },
    { label:'Compare', data:[], borderColor:'#00eaff', tension:0.25, pointRadius:1, borderDash:[4,3], hidden:true }
  ]},
  options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{display:true, labels:{color:'#fff'}},
      zoom:{ pan:{ enabled:true, mode:'x' }, zoom:{ wheel:{ enabled:true }, pinch:{enabled:true}, mode:'x' } }
    },
    scales:{ x:{ ticks:{ color:'#fff' } }, y:{ ticks:{ color:'#fff' } }
  }
}});

/* ================== AQI meta + health advice ================== */
function aqiMeta(ppm){
  ppm = Number(ppm) || 0;
  if(ppm < 80) return { label:'Good', color:'#19d37c', health:'Low risk. Normal activities.' };
  if(ppm < 150) return { label:'Moderate', color:'#ffd166', health:'Reduce prolonged outdoor exertion.' };
  if(ppm < 250) return { label:'Unhealthy', color:'#ff4d6d', health:'Avoid long outdoor activity.' };
  return { label:'Hazardous', color:'#b84cff', health:'Stay indoors; use masks/air purifiers.' };
}

/* update cards & UI */
function updateCards(obj){
  document.getElementById('tempCard').innerText = (obj.temperature!==undefined?obj.temperature:'--') + ' °C';
  document.getElementById('humCard').innerText = (obj.humidity!==undefined?obj.humidity:'--') + ' %';
  document.getElementById('ppmCard').innerText = (obj.gas_ppm!==undefined?obj.gas_ppm:'--');
  const meta = aqiMeta(obj.gas_ppm);
  const stat = document.getElementById('statusCard'); stat.innerText = meta.label; stat.style.background = `linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))`; stat.style.color = meta.color;
  document.getElementById('connStatus').innerText = connected?'Online':'Offline';
  document.getElementById('lastSeen').innerText = 'Last update: ' + (lastTimestamp ? new Date(parseTS(lastTimestamp)).toLocaleString() : '--');
  // health list adaptively
  const list = document.getElementById('healthList'); list.innerHTML=''; const items=[meta.health, 'If you have respiratory conditions, keep inhaler/meds handy.', 'Consider indoor purifier when AQI is high.'];
  items.forEach(it=>{ const li=document.createElement('li'); li.innerText=it; list.appendChild(li); });
}

/* ================== LSTM (tiny) forecast with TF.js ================== */
/* NOTE: This is a lightweight in-browser LSTM: it's intended for quick approximate forecasts on recent data.
   For production-grade 12-hour forecasts you should train offline on historical dataset and load a pre-trained model.
*/
async function trainAndForecast(ppmArr, nSteps=12){
  if(!ppmArr || ppmArr.length < 12) return null;
  // deduce sampling interval (approx) from stored timestamps if available
  // normalize data to [0,1]
  const arr = ppmArr.map(x=>Number(x)||0);
  const maxV = Math.max(...arr); const minV = Math.min(...arr);
  const norm = v => (v - minV) / (maxV - minV + 1e-6);
  const inv = y => y*(maxV-minV) + minV;
  const windowSize = Math.min(20, Math.floor(arr.length/2) || 6);
  const xs = [], ys = [];
  for(let i=0;i + windowSize < arr.length; i++){
    xs.push(arr.slice(i,i+windowSize).map(norm));
    ys.push(arr[i+windowSize]);
  }
  if(xs.length < 3) return null;
  // convert to tensors
  const tensorXs = tf.tensor(xs).expandDims(2); // shape [samples, windowSize, 1]
  const tensorYs = tf.tensor(ys).reshape([ys.length,1]);
  // build tiny model
  const model = tf.sequential();
  model.add(tf.layers.lstm({ units: 24, inputShape: [windowSize,1], returnSequences:false }));
  model.add(tf.layers.dense({ units: 12 })); // predict 12 future points
  model.compile({ optimizer:'adam', loss:'meanSquaredError' });
  // train (small epochs)
  try{
    await model.fit(tensorXs, tensorYs, { epochs: 30, batchSize: 8, verbose:0 });
  }catch(e){ console.warn('TF train err',e); }
  // iterative multi-step prediction starting with last window
  let seed = arr.slice(-windowSize).map(norm);
  const predsNorm = [];
  for(let step=0; step<nSteps; step++){
    const predTensor = model.predict(tf.tensor([seed]).expandDims(2));
    // predTensor shape [1,12] (dense output) -> we take first element
    const predArr = await predTensor.array();
    const nextVal = predArr[0][0]; // take first of dense outputs as next step
    predsNorm.push(nextVal);
    // slide seed
    seed = seed.slice(1); seed.push(nextVal);
    tf.dispose(predTensor);
  }
  // convert back
  const preds = predsNorm.map(p=> Math.round(inv(p)));
  // cleanup
  tensorXs.dispose(); tensorYs.dispose(); model.dispose(); tf.engine().disposeVariables();
  return preds;
}

/* ================== Trend analysis (simple slope) ================== */
function classifyTrend(arr){
  if(!arr || arr.length<3) return 'stable';
  // compute slope of last N points linear regression
  const N = Math.min(arr.length, 12);
  const slice = arr.slice(-N).map(x=>Number(x)||0);
  const xs = Array.from({length:N}, (_,i)=>i);
  const xMean = xs.reduce((a,b)=>a+b,0)/N; const yMean = slice.reduce((a,b)=>a+b,0)/N;
  let num=0, den=0; for(let i=0;i<N;i++){ num+=(xs[i]-xMean)*(slice[i]-yMean); den+=(xs[i]-xMean)*(xs[i]-xMean); }
  const m = (den===0)?0:num/den;
  if(m > 0.2) return 'rising';
  if(m < -0.2) return 'falling';
  return 'stable';
}

/* ================== Firebase realtime listener (safe) ================== */
window.addEventListener('load', ()=>{
  // safe: charts exist now
  // compute approximate sampling interval using timestamps if we get >1 sample
  firebase.database().ref(REF).limitToLast(1).on('child_added', async snap=>{
    try{
      const val = snap.val(); if(!val) return;
      connected = true; lastTimestamp = snap.key || new Date().toISOString();
      // push history
      liveHistory.push({ ts: lastTimestamp, ...val });
      if(liveHistory.length > 2000) liveHistory.shift();
      // derive sampling interval if >=2 points
      if(liveHistory.length >= 2){
        const t0 = parseTS(liveHistory[liveHistory.length-2].ts); const t1 = parseTS(liveHistory[liveHistory.length-1].ts);
        if(!isNaN(t0) && !isNaN(t1)) forecastIntervalMs = Math.max(1000, t1 - t0);
      }
      // live chart push
      const tLabel = new Date(parseTS(lastTimestamp)).toLocaleTimeString();
      liveChart.data.labels.push(tLabel);
      liveChart.data.datasets[0].data.push(Number(val.gas_ppm) || 0);
      liveChart.data.datasets[1].data.push(Number(val.temperature) || 0);
      liveChart.data.datasets[2].data.push(Number(val.humidity) || 0);
      if(liveChart.data.labels.length > 60){ liveChart.data.labels.shift(); liveChart.data.datasets.forEach(d=>d.data.shift()); }
      liveChart.update();
      updateCards(val);
      // run forecast on recent ppm
      const ppmArr = liveHistory.map(x=>Number(x.gas_ppm) || 0);
      // run linear forecast quickly for immediate display:
      const linearPred = linearRegressionPredict(ppmArr, 12);
      // show immediate prediction
      renderForecastPills(linearPred);
      // also train tiny LSTM in background for refined forecast (async)
      try{
        const lstmPred = await trainAndForecast(ppmArr, 12);
        if(lstmPred && lstmPred.length>0) renderForecastPills(lstmPred, true);
      }catch(e){ console.warn('LSTM error',e); }
      // trend
      const trend = classifyTrend(ppmArr);
      document.getElementById('trendBox').innerText = trend.toUpperCase();
      // alerts thresholds
      const meta = aqiMeta(val.gas_ppm);
      if(Number(val.gas_ppm) >= userThresholds.ppm){
        if(document.getElementById('enableOnScreen')?.checked) showAlert('Threshold reached: ' + meta.label, meta.color);
        speak('Warning: Air quality ' + meta.label);
      }
    }catch(e){
      console.warn('listener err', e);
    }
  }, err => { console.warn('firebase on err', err); showAlert('Realtime connection error'); });
});

/* quick linear regression predictor (fallback, fast) */
function linearRegressionPredict(arr, forwardSteps=6){
  const N = Math.min(20, arr.length); if(N<3) return null;
  const xs = [], ys = []; for(let i=0;i<N;i++){ xs.push(i); ys.push(arr[arr.length-N+i]); }
  const xMean = xs.reduce((a,b)=>a+b,0)/N; const yMean = ys.reduce((a,b)=>a+b,0)/N;
  let num=0,den=0; for(let i=0;i<N;i++){ num+=(xs[i]-xMean)*(ys[i]-yMean); den+=(xs[i]-xMean)*(xs[i]-xMean); }
  const m = den===0?0:num/den; const c = yMean - m*xMean; const preds = [];
  for(let s=1;s<=forwardSteps;s++){ preds.push(Math.max(0, Math.round(m*(N+s-1)+c))); }
  return preds;
}

/* render forecast pills */
function renderForecastPills(predArr, sourceIsLstm=false){
  const box = document.getElementById('forecastPills');
  box.innerHTML='';
  if(!predArr || predArr.length===0) { document.getElementById('predictionSummary').innerText = 'Insufficient data for forecast.'; return; }
  predArr.forEach((v,i)=>{
    const p = document.createElement('div'); p.style.padding='8px 10px'; p.style.borderRadius='8px'; p.style.background='rgba(255,255,255,0.02)'; p.style.marginRight='6px';
    p.innerHTML = `<div style="font-weight:700">${v}</div><div style="font-size:11px;color:var(--muted)">t+${i+1}</div>`;
    box.appendChild(p);
  });
  document.getElementById('predictionSummary').innerText = (sourceIsLstm ? 'LSTM forecast (approx):' : 'Quick linear forecast:') + ' next ' + predArr.length + ' steps.';
}

/* ================== toggle live datasets */
document.getElementById('btnPPM').addEventListener('click', ()=>{ setLiveMode('ppm'); });
document.getElementById('btnTemp').addEventListener('click', ()=>{ setLiveMode('temp'); });
document.getElementById('btnHum').addEventListener('click', ()=>{ setLiveMode('hum'); });
document.getElementById('btnAll').addEventListener('click', ()=>{ setLiveMode('all'); });
function setLiveMode(mode){
  if(mode==='ppm'){ liveChart.data.datasets[0].hidden=false; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=true; document.getElementById('liveIndicator').innerText='Live: PPM'; }
  if(mode==='temp'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=false; liveChart.data.datasets[2].hidden=true; document.getElementById('liveIndicator').innerText='Live: Temp'; }
  if(mode==='hum'){ liveChart.data.datasets[0].hidden=true; liveChart.data.datasets[1].hidden=true; liveChart.data.datasets[2].hidden=false; document.getElementById('liveIndicator').innerText='Live: Humidity'; }
  if(mode==='all'){ liveChart.data.datasets.forEach(d=>d.hidden=false); document.getElementById('liveIndicator').innerText='Live: All'; }
  liveChart.update();
}

/* ================== CSV */
document.getElementById('downloadCsv').addEventListener('click', ()=>{
  if(liveHistory.length===0){ showAlert('No data to download'); return; }
  const headers = ['timestamp','temperature_c','humidity_pct','mq135_ppm','status'];
  const rows = liveHistory.map(r=>[r.ts||'', r.temperature, r.humidity, r.gas_ppm, r.status||'']);
  let csv = headers.join(',') + '\n';
  rows.forEach(r=> csv += r.map(v=> '"' + String(v).replace(/"/g,'""') + '"').join(',') + '\n' );
  const blob = new Blob([csv], { type:'text/csv' }); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${DEVICE_ID}_data.csv`; a.click(); URL.revokeObjectURL(url);
});

/* ================== Historical loading & comparison */
async function loadRange(startMs, endMs, metric='ppm'){
  try{
    const snap = await firebase.database().ref(REF).once('value');
    const data = snap.val(); if(!data){ showAlert('No historical data'); return; }
    const items = Object.keys(data).map(k => ({ ts:k, ...data[k] }));
    const filtered = items.filter(it => { const ts=parseTS(it.ts); return !isNaN(ts) && ts>=startMs && ts<=endMs; });
    filtered.sort((a,b)=> parseTS(a.ts) - parseTS(b.ts) );
    // labels as local times
    histChart.data.labels = filtered.map(x => new Date(parseTS(x.ts)).toLocaleString());
    // metric mapping
    if(metric === 'ppm'){ histChart.data.datasets[0].data = filtered.map(x=>Number(x.gas_ppm)||0); histChart.data.datasets[0].label='AQI (PPM)'; }
    if(metric === 'temp'){ histChart.data.datasets[0].data = filtered.map(x=>Number(x.temperature)||0); histChart.data.datasets[0].label='Temp (C)'; }
    if(metric === 'hum'){ histChart.data.datasets[0].data = filtered.map(x=>Number(x.humidity)||0); histChart.data.datasets[0].label='Humidity (%)'; }
    histChart.update();
    showAlert('Loaded ' + filtered.length + ' points');
  }catch(e){ console.error(e); showAlert('Error loading history: '+e.message); }
}

/* handy wrappers for common ranges */
function setRange(mode){
  if(mode==='today'){ const now=new Date(); const start=new Date(now.getFullYear(),now.getMonth(),now.getDate()); loadRange(start.getTime(), Date.now(), document.getElementById('metricCompare').value); }
  if(mode==='yesterday'){ const now=new Date(); const s=new Date(now.getFullYear(),now.getMonth(),now.getDate()-1); const e=new Date(now.getFullYear(),now.getMonth(),now.getDate()); loadRange(s.getTime(), e.getTime(), document.getElementById('metricCompare').value); }
  if(mode==='3days'){ const end=Date.now(); const start=end - 3*24*60*60*1000; loadRange(start,end,document.getElementById('metricCompare').value); }
  if(mode==='24h'){ const end=Date.now(); const start=end - 24*60*60*1000; loadRange(start,end,document.getElementById('metricCompare').value); }
}

/* attach load button */
document.getElementById('metricCompare').addEventListener('change', ()=>{ // reload current last24h by default
  setRange('24h');
});

/* comparison overlay: load previous day and overlay */
async function compareWithYesterday(){
  try{
    const now=new Date(); const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();
    const yesterdayStart = todayStart - 24*60*60*1000;
    // load today main into dataset0 and yesterday into dataset1
    await loadRange(todayStart, Date.now(), document.getElementById('metricCompare').value);
    // fetch yesterday separate
    const snap = await firebase.database().ref(REF).once('value'); const data = snap.val(); if(!data) return;
    const items = Object.keys(data).map(k=>({ts:k,...data[k]}));
    const filtered = items.filter(it=>{ const ts=parseTS(it.ts); return !isNaN(ts) && ts>=yesterdayStart && ts<todayStart; }).sort((a,b)=>parseTS(a.ts)-parseTS(b.ts));
    histChart.data.datasets[1].data = filtered.map(x=> {
      const metric = document.getElementById('metricCompare').value;
      return metric==='ppm'?Number(x.gas_ppm)||0:(metric==='temp'?Number(x.temperature)||0:Number(x.humidity)||0);
    });
    histChart.data.datasets[1].hidden=false;
    histChart.update();
  }catch(e){ console.warn(e); }
}
document.getElementById('metricCompare').addEventListener('change', ()=> setRange('24h'));

/* ================== Zoom controls safe wrappers */
function safeZoom(factor){
  try{ histChart.zoom(factor); }catch(e){ showAlert('Zoom plugin blocked; using fallback'); tryAdjustWindow(factor); }
}
document.getElementById('zoomInBtn').addEventListener('click', ()=> safeZoom(1.2));
document.getElementById('zoomOutBtn').addEventListener('click', ()=> safeZoom(0.8));
document.getElementById('resetZoomBtn').addEventListener('click', ()=> { try{ histChart.resetZoom(); }catch(e){ tryAdjustWindow(null); } });

/* ================== Alert customization modal (simple prompt-based) */
document.getElementById('settingsBtn').addEventListener('click', ()=>{
  const newPpm = prompt('Set PPM threshold for alerts (current ' + userThresholds.ppm + ')', userThresholds.ppm);
  if(newPpm !== null){ const n = Number(newPpm); if(!isNaN(n)) userThresholds.ppm = n; }
  const newTemp = prompt('Set Temperature (°C) threshold for alerts (current ' + userThresholds.temp + ')', userThresholds.temp);
  if(newTemp !== null){ const n = Number(newTemp); if(!isNaN(n)) userThresholds.temp = n; }
  const newHum = prompt('Set Humidity (%) threshold for alerts (current ' + userThresholds.hum + ')', userThresholds.hum);
  if(newHum !== null){ const n = Number(newHum); if(!isNaN(n)) userThresholds.hum = n; }
  showAlert('Thresholds updated');
});

/* ================== PWA: manifest + service worker registration (inline generation) */
const manifest = {
  name: "ARTIFEX AQI",
  short_name: "ARTIFEX",
  start_url: ".",
  display: "standalone",
  background_color: "#050505",
  theme_color: "#00eaff",
  icons: [
    { src: "data:image/svg+xml;base64," + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect rx="40" width="512" height="512" fill="#00eaff"/><text x="50%" y="55%" font-size="200" text-anchor="middle" fill="#001" font-family="Arial">ART</text></svg>'), sizes: "512x512", type: "image/svg+xml" }
  ]
};
// attach manifest as blob url
const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
document.getElementById('manifestLink').href = manifestURL;

// register a simple service worker (inline create and register)
if('serviceWorker' in navigator){
  const swCode = `
    self.addEventListener('install', (e)=>{ self.skipWaiting(); });
    self.addEventListener('activate', (e)=>{ self.clients.claim(); });
    self.addEventListener('fetch', (e)=>{ /* fall back to network; caching can be added */ });
  `;
  const swBlob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl).then(()=> console.log('SW registered')).catch(e=> console.warn('SW failed', e));
}

// Add to Home Screen prompt handling
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display='inline-block';
});
document.getElementById('installBtn').addEventListener('click', async ()=>{
  if(deferredPrompt){ deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; deferredPrompt=null; }
});

/* ================== initial UI animation + load default history 24h */
gsap.from('.card',{y:12,opacity:0,duration:0.7,stagger:0.05});
setTimeout(()=> setRange('24h'), 800);

/* connection indicator update loop (based on lastTimestamp) */
setInterval(()=> {
  if(!lastTimestamp){ document.getElementById('connStatus').innerText='Offline'; document.getElementById('connDot').style.background='#ffd166'; return; }
  const last = parseTS(lastTimestamp); if(isNaN(last)){ document.getElementById('connStatus').innerText='Offline'; document.getElementById('connDot').style.background='#ffd166'; return; }
  const diff = Date.now() - last; const online = diff < 120000;
  document.getElementById('connStatus').innerText = online?'Online':'Offline';
  document.getElementById('connDot').style.background = online ? '#19d37c' : '#ffd166';
}, 4000);

</script>
</body>
</html>
